import { useState, useEffect, useRef } from 'react';
import { AlertCircle, ArrowLeft, CheckCircle2, FileText, Lock, MapPin, Plus, Trash2, Upload, X } from 'lucide-react';
import { supabase } from '../lib/supabase';
import { generateReport, generateSection, ReportSection, SectionId } from '../utils/reportGenerator';
import ReportViewer from './ReportViewer';
import BuildingForm from './BuildingForm';
import GpsMap from './GpsMap';
import ProgressBar from './ProgressBar';
import StickySaveButton from './StickySaveButton';
import DraftReportModal from './DraftReportModal';
import { calculateOverallGrade, getRiskBandFromGrade, SectionGrades, getSectorWeightsFromDB, fetchSectorWeightings, SectorWeighting } from '../utils/riskScoring';
import RatingRadio from './RatingRadio';
import { getRecommendationForRating, shouldGenerateRecommendation } from '../utils/recommendationTemplates';
import { ensureReferenceNumbers, getSurveyYear } from '../utils/recommendationReferenceNumber';
import SectionGrade from './SectionGrade';

interface Hazard {
  id: string;
  title: string;
  description: string;
  rating: string;
}

interface SpecialHazard {
  id: string;
  title: string;
  description: string;
  rating: string;
}

interface OverallComment {
  id: string;
  hazard: string;
  description: string;
  client_response: string;
  status: string;
  isAutoGenerated?: boolean;
  sourceRatingField?: string;
  images?: string[];
  priority?: 'Critical' | 'High' | 'Medium' | 'Low';
  priority_override?: 'Critical' | 'High' | 'Medium' | 'Low' | '';
  driver_dimension?: 'construction' | 'fire_protection' | 'detection' | 'management' | 'special_hazards' | 'business_interruption';
}

interface SumsInsuredRow {
  id: string;
  item: string;
  pd_value: string;
}

interface WorstCasePDRow {
  id: string;
  item: string;
  percent: string;
  subtotal: number;
}

interface WorstCaseBIRow {
  id: string;
  item: string;
  months: string;
  percent: string;
  subtotal: number;
}

interface NLEAllRIsPDRow {
  id: string;
  item: string;
  percent: string;
  subtotal: number;
}

interface NLEAllRIsBIRow {
  id: string;
  item: string;
  months: string;
  percent: string;
  subtotal: number;
}

interface NaturalHazard {
  id: string;
  hazardType: 'river_flooding' | 'surface_water_flooding' | 'earthquake' | 'windstorm' | 'other';
  description: string;
  rating: string;
}

interface UploadedFile {
  id: string;
  name: string;
  url: string;
  type: 'photo' | 'site-plan';
}

interface BuildingConstruction {
  heavy_non_combustible_pct: number;
  light_non_combustible_pct: number;
  foam_plastic_approved_pct: number;
  foam_plastic_unapproved_pct: number;
  other_combustible_pct: number;
}

interface Building {
  id: string;
  building_name: string;
  year_built: string;
  building_frame: string;
  number_of_floors: string;
  building_height_m: string;
  floor_area_sqm: string;
  roof_area_sqm: string;
  construction: {
    walls: BuildingConstruction;
    roof_ceiling: BuildingConstruction;
  };
  fire_protection: {
    sprinkler_coverage_pct: number;
    detection_coverage_pct: number;
  };
  fire_protection_summary: {
    required_pct: string;
    recommended_pct: string;
    adequacy_rating: string;
    reliability_rating: string;
  };
  fire_detection: {
    rating: string;
    notes: string;
  };
  fire_hydrant: {
    rating: string;
    notes: string;
  };
  water_supply_rating: string;
  water_supply_notes: string;
  construction_description: string;
  fire_compartmentation_description: string;
}

interface FormData {
  referenceNumber: string;
  propertyName: string;
  clientCompanyName: string;
  addressLines: string;
  townCity: string;
  postcode: string;
  country: string;
  propertyType: string;
  primaryOccupancy: string;
  surveyorName: string;
  surveyorCompanyName: string;
  companyName: string;
  surveyDate: string;
  siteContact: string;
  discussionsOnSite: string[];
  wclScenarioDescription: string;
  nleScenarioDescription: string;
  buildings: Building[];
  activityOverview: string;
  fireProtectionDescription: string;
  processUtilities: string;
  inspectionDate: string;
  surveyScope: string;
  surveyScopeOtherText: string;
  companySiteBackground: string;
  occupancyProductsServices: string;
  employeesOperatingHours: string;
  commitmentLossPrevention: string;
  commitmentLossPrevention_rating: string;
  fireEquipmentTesting: string;
  fireEquipmentTesting_rating: string;
  controlHotWork: string;
  controlHotWork_rating: string;
  electricalMaintenance: string;
  electricalMaintenance_rating: string;
  generalMaintenance: string;
  generalMaintenance_rating: string;
  selfInspections: string;
  selfInspections_rating: string;
  changeManagement: string;
  changeManagement_rating: string;
  contractorControls: string;
  contractorControls_rating: string;
  impairmentHandling: string;
  impairmentHandling_rating: string;
  smokingControls: string;
  smokingControls_rating: string;
  fireSafetyHousekeeping: string;
  fireSafetyHousekeeping_rating: string;
  emergencyResponse: string;
  emergencyResponse_rating: string;
  fixedFireProtectionSystems: string;
  fireDetectionAlarmSystems: string;
  waterSupplies: string;
  businessInterruption: string;
  interdependencies: string;
  bcp: string;
  bcp_rating: string;
  fireProtectionNotes: string;
  fireDetectionNotes: string;
  fireDetectionNotes_rating: string;
  fireHydrantNotes: string;
  fireHydrantNotes_rating: string;
  waterSupplyNotes: string;
  waterSupplyNotes_rating: string;
  allowGenerateDraftRecommendations: boolean;
  reviewerName: string;
  reviewerEmail: string;
  reportStatus: 'Draft' | 'Issue Ready';
  industrySector: string;
  sectionGrades: SectionGrades;
  overallGrade: number;
  riskBand: string;
}

interface NewSurveyReportProps {
  surveyId?: string | null;
  onCancel?: () => void;
}

const getCountryAbbreviation = (country: string): string => {
  const abbreviations: Record<string, string> = {
    'United Kingdom': 'UK',
    'United States': 'US',
    'Canada': 'CA',
    'Australia': 'AU',
    'New Zealand': 'NZ',
    'Ireland': 'IE',
    'Germany': 'DE',
    'France': 'FR',
    'Italy': 'IT',
    'Spain': 'ES',
    'Netherlands': 'NL',
    'Belgium': 'BE',
    'Switzerland': 'CH',
    'Austria': 'AT',
    'Denmark': 'DK',
    'Sweden': 'SE',
    'Norway': 'NO',
    'Finland': 'FI',
    'Poland': 'PL',
    'Czech Republic': 'CZ',
    'Portugal': 'PT',
    'Greece': 'GR',
    'Luxembourg': 'LU',
    'Iceland': 'IS',
    'Japan': 'JP',
    'South Korea': 'KR',
    'Singapore': 'SG',
    'Hong Kong': 'HK',
    'Taiwan': 'TW',
    'Israel': 'IL',
    'United Arab Emirates': 'AE',
    'Qatar': 'QA',
    'Saudi Arabia': 'SA',
    'China': 'CN',
    'India': 'IN',
    'Brazil': 'BR',
    'Mexico': 'MX',
    'Argentina': 'AR',
    'Chile': 'CL',
    'South Africa': 'ZA',
    'Russia': 'RU',
    'Turkey': 'TR',
    'Malaysia': 'MY',
    'Thailand': 'TH',
    'Indonesia': 'ID',
    'Philippines': 'PH',
    'Vietnam': 'VN',
  };
  return abbreviations[country] || 'XX';
};

const generateReferenceNumber = (country: string): string => {
  const countryCode = getCountryAbbreviation(country);
  const timestamp = Date.now().toString();
  const randomDigits = timestamp.slice(-5);
  return `${countryCode}${randomDigits}`;
};

export default function NewSurveyReport({ surveyId, onCancel }: NewSurveyReportProps) {
  const [hazards, setHazards] = useState<Hazard[]>([
    { id: crypto.randomUUID(), title: '', description: '', rating: '' }
  ]);

  const [specialHazards, setSpecialHazards] = useState<SpecialHazard[]>([
    { id: crypto.randomUUID(), title: '', description: '', rating: '' }
  ]);

  const [overallComments, setOverallComments] = useState<OverallComment[]>([
    { id: crypto.randomUUID(), hazard: '', description: '', client_response: '', status: '' }
  ]);

  const [sumsInsured, setSumsInsured] = useState<SumsInsuredRow[]>([
    { id: crypto.randomUUID(), item: 'Buildings + Improvements', pd_value: '' },
    { id: crypto.randomUUID(), item: 'Plant & Machinery + Contents', pd_value: '' },
    { id: crypto.randomUUID(), item: 'Stock & WIP', pd_value: '' },
    { id: crypto.randomUUID(), item: 'Other', pd_value: '' },
  ]);

  const [businessInterruptionValue, setBusinessInterruptionValue] = useState('');
  const [indemnityPeriod, setIndemnityPeriod] = useState('');
  const [selectedCurrency, setSelectedCurrency] = useState('GBP');

  const [lossExpectancyComments, setLossExpectancyComments] = useState('');

  const [worstCasePD, setWorstCasePD] = useState<WorstCasePDRow[]>([
    { id: crypto.randomUUID(), item: 'Buildings + Improvements', percent: '', subtotal: 0 },
    { id: crypto.randomUUID(), item: 'Plant & Machinery + Contents', percent: '', subtotal: 0 },
    { id: crypto.randomUUID(), item: 'Stock & WIP', percent: '', subtotal: 0 },
  ]);

  const [worstCaseBI, setWorstCaseBI] = useState<WorstCaseBIRow[]>([
    { id: crypto.randomUUID(), item: 'Initial Outage Period', months: '', percent: '', subtotal: 0 },
    { id: crypto.randomUUID(), item: '1st Recovery Phase', months: '', percent: '', subtotal: 0 },
  ]);

  const [nleAllRIsPD, setNleAllRIsPD] = useState<NLEAllRIsPDRow[]>([
    { id: crypto.randomUUID(), item: 'Buildings + Improvements', percent: '', subtotal: 0 },
    { id: crypto.randomUUID(), item: 'Plant & Machinery + Contents', percent: '', subtotal: 0 },
    { id: crypto.randomUUID(), item: 'Stock & WIP', percent: '', subtotal: 0 },
  ]);

  const [nleAllRIsBI, setNleAllRIsBI] = useState<NLEAllRIsBIRow[]>([
    { id: crypto.randomUUID(), item: 'Initial Outage Period', months: '', percent: '', subtotal: 0 },
    { id: crypto.randomUUID(), item: '1st Recovery Phase', months: '', percent: '', subtotal: 0 },
  ]);

  const [naturalHazards, setNaturalHazards] = useState<NaturalHazard[]>([]);

  const [latitude, setLatitude] = useState<number | null>(null);
  const [longitude, setLongitude] = useState<number | null>(null);
  const [isGeocoding, setIsGeocoding] = useState(false);

  const [uploadedFiles, setUploadedFiles] = useState<UploadedFile[]>([]);
  const [isUploading, setIsUploading] = useState(false);

  const createEmptyBuilding = (): Building => ({
    id: crypto.randomUUID(),
    building_name: '',
    year_built: '',
    building_frame: '',
    number_of_floors: '',
    building_height_m: '',
    floor_area_sqm: '',
    roof_area_sqm: '',
    construction: {
      walls: {
        heavy_non_combustible_pct: 0,
        light_non_combustible_pct: 0,
        foam_plastic_approved_pct: 0,
        foam_plastic_unapproved_pct: 0,
        other_combustible_pct: 0,
      },
      roof_ceiling: {
        heavy_non_combustible_pct: 0,
        light_non_combustible_pct: 0,
        foam_plastic_approved_pct: 0,
        foam_plastic_unapproved_pct: 0,
        other_combustible_pct: 0,
      },
    },
    fire_protection: {
      sprinkler_coverage_pct: 0,
      detection_coverage_pct: 0,
    },
    fire_protection_summary: {
      required_pct: '',
      recommended_pct: '',
      adequacy_rating: '',
      reliability_rating: '',
    },
    fire_detection: {
      rating: '',
      notes: '',
    },
    fire_hydrant: {
      rating: '',
      notes: '',
    },
    water_supply_rating: '',
    water_supply_notes: '',
    construction_description: '',
    fire_compartmentation_description: '',
  });

  const [formData, setFormData] = useState<FormData>({
    referenceNumber: '',
    propertyName: '',
    clientCompanyName: '',
    addressLines: '',
    townCity: '',
    postcode: '',
    country: 'United Kingdom',
    propertyType: '',
    primaryOccupancy: '',
    surveyorName: '',
    surveyorCompanyName: '',
    companyName: '',
    surveyDate: new Date().toISOString().split('T')[0],
    siteContact: '',
    discussionsOnSite: [''],
    wclScenarioDescription: '',
    nleScenarioDescription: '',
    buildings: [createEmptyBuilding()],
    activityOverview: '',
    fireProtectionDescription: '',
    processUtilities: '',
    inspectionDate: '',
    surveyScope: '',
    surveyScopeOtherText: '',
    companySiteBackground: '',
    occupancyProductsServices: '',
    employeesOperatingHours: '',
    commitmentLossPrevention: '',
    commitmentLossPrevention_rating: '',
    fireEquipmentTesting: '',
    fireEquipmentTesting_rating: '',
    controlHotWork: '',
    controlHotWork_rating: '',
    electricalMaintenance: '',
    electricalMaintenance_rating: '',
    generalMaintenance: '',
    generalMaintenance_rating: '',
    selfInspections: '',
    selfInspections_rating: '',
    changeManagement: '',
    changeManagement_rating: '',
    contractorControls: '',
    contractorControls_rating: '',
    impairmentHandling: '',
    impairmentHandling_rating: '',
    smokingControls: '',
    smokingControls_rating: '',
    fireSafetyHousekeeping: '',
    fireSafetyHousekeeping_rating: '',
    emergencyResponse: '',
    emergencyResponse_rating: '',
    fixedFireProtectionSystems: '',
    fireDetectionAlarmSystems: '',
    waterSupplies: '',
    businessInterruption: '',
    interdependencies: '',
    bcp: '',
    bcp_rating: '',
    fireProtectionNotes: '',
    fireDetectionNotes: '',
    fireDetectionNotes_rating: '',
    fireHydrantNotes: '',
    fireHydrantNotes_rating: '',
    waterSupplyNotes: '',
    waterSupplyNotes_rating: '',
    allowGenerateDraftRecommendations: false,
    reviewerName: '',
    reviewerEmail: '',
    reportStatus: 'Draft',
    industrySector: '',
    sectionGrades: {
      survey_info: 3,
      property_details: 3,
      construction: 3,
      occupancy: 3,
      management: 3,
      fire_protection: 3,
      business_continuity: 3,
      loss_expectancy: 3,
      hazards: 3,
      natural_hazards: 3,
      recommendations: 3,
      attachments: 3,
    },
    overallGrade: 3,
    riskBand: 'Medium',
  });

  const [isSubmitting, setIsSubmitting] = useState(false);
  const [submitStatus, setSubmitStatus] = useState<'idle' | 'success' | 'error'>('idle');
  const [errorMessage, setErrorMessage] = useState('');
  const [generatedReport, setGeneratedReport] = useState<{ sections: ReportSection[], fullText: string } | null>(null);
  const [isSaving, setIsSaving] = useState(false);
  const [saveStatus, setSaveStatus] = useState<'idle' | 'success' | 'error'>('idle');
  const [saveErrorMessage, setSaveErrorMessage] = useState('');
  const [currentSurveyId, setCurrentSurveyId] = useState<string | null>(null);
  const [isLoadingSurvey, setIsLoadingSurvey] = useState(false);
  const [lastSaved, setLastSaved] = useState<string | null>(null);
  const [isDraftModalOpen, setIsDraftModalOpen] = useState(false);
  const [surveyType, setSurveyType] = useState<'Full' | 'Abridged'>('Full');
  const [isIssued, setIsIssued] = useState(false);
  const [externalEditActive, setExternalEditActive] = useState(false);
  const [sectorWeightings, setSectorWeightings] = useState<SectorWeighting[]>([]);

  const previousRatingsRef = useRef<Record<string, string>>({});
  const previousBuildingRatingsRef = useRef<Record<string, { adequacy: string; waterSupply: string }>>({});

  useEffect(() => {
    (async () => {
      const weightings = await fetchSectorWeightings();
      setSectorWeightings(weightings);
    })();
  }, []);

  // Auto-generate recommendations when ratings change to Poor or Inadequate
  useEffect(() => {
    const ratingFields = [
      'commitmentLossPrevention_rating',
      'fireEquipmentTesting_rating',
      'controlHotWork_rating',
      'electricalMaintenance_rating',
      'generalMaintenance_rating',
      'smokingControls_rating',
      'fireSafetyHousekeeping_rating',
      'selfInspections_rating',
      'changeManagement_rating',
      'contractorControls_rating',
      'impairmentHandling_rating',
      'emergencyResponse_rating',
      'fireDetectionNotes_rating',
      'fireHydrantNotes_rating',
      'waterSupplyNotes_rating',
      'bcp_rating',
    ];

    ratingFields.forEach((field) => {
      const currentValue = formData[field as keyof FormData] as string;
      const previousValue = previousRatingsRef.current[field] || '';

      if (shouldGenerateRecommendation(previousValue, currentValue)) {
        const recommendation = getRecommendationForRating(field, currentValue);

        if (recommendation) {
          // Check if we already have an auto-generated recommendation for this field
          const existingRecommendation = overallComments.find(
            (comment) => comment.sourceRatingField === field && comment.isAutoGenerated
          );

          if (!existingRecommendation) {
            // Add new auto-generated recommendation
            const newComment: OverallComment = {
              id: crypto.randomUUID(),
              hazard: recommendation.title,
              description: recommendation.template,
              client_response: '',
              status: 'Open',
              isAutoGenerated: true,
              sourceRatingField: field,
            };

            setOverallComments((prev) => {
              // Remove blank recommendations (where both hazard and description are empty)
              const filteredComments = prev.filter(
                (comment) => comment.hazard.trim() !== '' || comment.description.trim() !== ''
              );
              return [...filteredComments, newComment];
            });
          }
        }
      }

      // Update previous value
      previousRatingsRef.current[field] = currentValue;
    });
  }, [
    formData.commitmentLossPrevention_rating,
    formData.fireEquipmentTesting_rating,
    formData.controlHotWork_rating,
    formData.electricalMaintenance_rating,
    formData.generalMaintenance_rating,
    formData.smokingControls_rating,
    formData.fireSafetyHousekeeping_rating,
    formData.selfInspections_rating,
    formData.changeManagement_rating,
    formData.contractorControls_rating,
    formData.impairmentHandling_rating,
    formData.emergencyResponse_rating,
    formData.fireDetectionNotes_rating,
    formData.fireHydrantNotes_rating,
    formData.waterSupplyNotes_rating,
    formData.bcp_rating,
  ]);

  // Auto-generate recommendations for building-specific ratings (Fire Protection table)
  useEffect(() => {
    formData.buildings.forEach((building) => {
      const buildingKey = building.id;
      const previousRatings = previousBuildingRatingsRef.current[buildingKey] || { adequacy: '', waterSupply: '' };

      // Check adequacy rating (Adequate/Tolerable/Inadequate)
      const currentAdequacy = building.fire_protection_summary.adequacy_rating;
      if (shouldGenerateRecommendation(previousRatings.adequacy, currentAdequacy)) {
        const recommendation = getRecommendationForRating('fire_protection_adequacy', currentAdequacy);

        if (recommendation) {
          const sourceField = `building_${buildingKey}_adequacy`;
          const existingRecommendation = overallComments.find(
            (comment) => comment.sourceRatingField === sourceField && comment.isAutoGenerated
          );

          if (!existingRecommendation) {
            const buildingName = building.building_name || 'Unnamed Building';
            const newComment: OverallComment = {
              id: crypto.randomUUID(),
              hazard: `${recommendation.title} - ${buildingName}`,
              description: `${buildingName}: ${recommendation.template}`,
              client_response: '',
              status: 'Open',
              isAutoGenerated: true,
              sourceRatingField: sourceField,
            };

            setOverallComments((prev) => {
              // Remove blank recommendations (where both hazard and description are empty)
              const filteredComments = prev.filter(
                (comment) => comment.hazard.trim() !== '' || comment.description.trim() !== ''
              );
              return [...filteredComments, newComment];
            });
          }
        }
      }

      // Check water supply rating (Reliable/Unreliable)
      const currentWaterSupply = building.water_supply_rating;
      if (shouldGenerateRecommendation(previousRatings.waterSupply, currentWaterSupply)) {
        const recommendation = getRecommendationForRating('water_supply_reliability', currentWaterSupply);

        if (recommendation) {
          const sourceField = `building_${buildingKey}_water_supply`;
          const existingRecommendation = overallComments.find(
            (comment) => comment.sourceRatingField === sourceField && comment.isAutoGenerated
          );

          if (!existingRecommendation) {
            const buildingName = building.building_name || 'Unnamed Building';
            const newComment: OverallComment = {
              id: crypto.randomUUID(),
              hazard: `${recommendation.title} - ${buildingName}`,
              description: `${buildingName}: ${recommendation.template}`,
              client_response: '',
              status: 'Open',
              isAutoGenerated: true,
              sourceRatingField: sourceField,
            };

            setOverallComments((prev) => {
              // Remove blank recommendations (where both hazard and description are empty)
              const filteredComments = prev.filter(
                (comment) => comment.hazard.trim() !== '' || comment.description.trim() !== ''
              );
              return [...filteredComments, newComment];
            });
          }
        }
      }

      // Update previous values
      previousBuildingRatingsRef.current[buildingKey] = {
        adequacy: currentAdequacy,
        waterSupply: currentWaterSupply,
      };
    });
  }, [formData.buildings]);

  // Auto-generate recommendations for special hazards with Poor or Tolerable ratings
  useEffect(() => {
    specialHazards.forEach((hazard) => {
      if (hazard.rating === 'Poor' || hazard.rating === 'Tolerable') {
        const sourceField = `special_hazard_${hazard.id}`;
        const existingRecommendation = overallComments.find(
          (comment) => comment.sourceRatingField === sourceField && comment.isAutoGenerated
        );

        if (!existingRecommendation && hazard.title && hazard.description) {
          const severity = hazard.rating === 'Poor' ? 'critical' : 'significant';
          const newComment: OverallComment = {
            id: crypto.randomUUID(),
            hazard: `Special Hazard: ${hazard.title}`,
            description: `This ${severity} special hazard requires immediate attention. ${hazard.description}. Implement appropriate controls, protection systems, and mitigation measures to reduce the fire risk associated with this hazard.`,
            client_response: '',
            status: 'Open',
            isAutoGenerated: true,
            sourceRatingField: sourceField,
          };

          setOverallComments((prev) => {
            const filteredComments = prev.filter(
              (comment) => comment.hazard.trim() !== '' || comment.description.trim() !== ''
            );
            return [...filteredComments, newComment];
          });
        }
      }
    });
  }, [specialHazards]);

  // Auto-generate recommendations for natural hazards with Poor or Tolerable ratings
  useEffect(() => {
    naturalHazards.forEach((hazard) => {
      if (hazard.rating === 'Poor' || hazard.rating === 'Tolerable') {
        const sourceField = `natural_hazard_${hazard.id}`;
        const existingRecommendation = overallComments.find(
          (comment) => comment.sourceRatingField === sourceField && comment.isAutoGenerated
        );

        if (!existingRecommendation && hazard.description) {
          const hazardTypeLabels = {
            river_flooding: 'River Flooding',
            surface_water_flooding: 'Surface Water Flooding',
            earthquake: 'Earthquake',
            windstorm: 'Windstorm',
            other: 'Natural Hazard'
          };
          const hazardLabel = hazardTypeLabels[hazard.hazardType];
          const severity = hazard.rating === 'Poor' ? 'significant' : 'moderate';

          const newComment: OverallComment = {
            id: crypto.randomUUID(),
            hazard: `Natural Hazard: ${hazardLabel}`,
            description: `This ${severity} natural hazard exposure requires attention. ${hazard.description}. Consider implementing flood defenses, emergency response plans, business continuity measures, and property protection systems to mitigate potential losses.`,
            client_response: '',
            status: 'Open',
            isAutoGenerated: true,
            sourceRatingField: sourceField,
          };

          setOverallComments((prev) => {
            const filteredComments = prev.filter(
              (comment) => comment.hazard.trim() !== '' || comment.description.trim() !== ''
            );
            return [...filteredComments, newComment];
          });
        }
      }
    });
  }, [naturalHazards]);

  useEffect(() => {
    if (surveyId) {
      loadSurvey(surveyId);
    } else if (!formData.referenceNumber) {
      setFormData(prev => ({
        ...prev,
        referenceNumber: generateReferenceNumber(prev.country)
      }));
    }
  }, [surveyId]);

  useEffect(() => {
    if (!surveyId && formData.referenceNumber) {
      setFormData(prev => ({
        ...prev,
        referenceNumber: generateReferenceNumber(prev.country)
      }));
    }
  }, [formData.country]);

  useEffect(() => {
    if (formData.industrySector) {
      (async () => {
        const weights = await getSectorWeightsFromDB(formData.industrySector);
        setFormData(prev => {
          if (
            prev.wConstruction === weights.construction &&
            prev.wProtection === weights.protection &&
            prev.wDetection === weights.detection &&
            prev.wManagement === weights.management &&
            prev.wHazards === weights.hazards &&
            prev.wBi === weights.bi
          ) {
            return prev;
          }

          return {
            ...prev,
            wConstruction: weights.construction,
            wProtection: weights.protection,
            wDetection: weights.detection,
            wManagement: weights.management,
            wHazards: weights.hazards,
            wBi: weights.bi,
          };
        });
      })();
    }
  }, [formData.industrySector]);

  useEffect(() => {
    const overallGrade = calculateOverallGrade(formData.sectionGrades);
    const band = getRiskBandFromGrade(overallGrade);

    const gradeChanged = Math.abs(overallGrade - formData.overallGrade) > 0.001;
    const bandChanged = band !== formData.riskBand;

    if (gradeChanged || bandChanged) {
      setFormData(prev => ({
        ...prev,
        overallGrade: overallGrade,
        riskBand: band,
      }));
    }
  }, [formData.sectionGrades, formData.overallGrade, formData.riskBand]);

  const loadSurvey = async (id: string) => {
    setIsLoadingSurvey(true);
    try {
      const { data, error } = await supabase
        .from('survey_reports')
        .select('*')
        .eq('id', id)
        .maybeSingle();

      if (error) throw error;

      if (data) {
        setCurrentSurveyId(data.id);
        setSurveyType((data.survey_type as 'Full' | 'Abridged') || 'Full');
        setIsIssued(data.issued || false);
        setExternalEditActive(data.external_edit_active || false);

        const formDataFromDb = data.form_data || {};

        setFormData({
          referenceNumber: formDataFromDb.referenceNumber || '',
          propertyName: data.property_name || '',
          addressLines: formDataFromDb.addressLines || data.property_address || '',
          townCity: formDataFromDb.townCity || '',
          postcode: formDataFromDb.postcode || '',
          country: formDataFromDb.country || 'UK',
          propertyType: formDataFromDb.propertyType || '',
          primaryOccupancy: formDataFromDb.primaryOccupancy || '',
          surveyorName: formDataFromDb.surveyorName || '',
          surveyorCompanyName: formDataFromDb.surveyorCompanyName || '',
          companyName: formDataFromDb.companyName || data.company_name || '',
          surveyDate: formDataFromDb.surveyDate || data.survey_date || new Date().toISOString().split('T')[0],
          siteContact: formDataFromDb.siteContact || '',
          discussionsOnSite: Array.isArray(formDataFromDb.discussionsOnSite)
            ? formDataFromDb.discussionsOnSite
            : (formDataFromDb.discussionsOnSite ? [formDataFromDb.discussionsOnSite] : ['']),
          wclScenarioDescription: formDataFromDb.wclScenarioDescription || '',
          nleScenarioDescription: formDataFromDb.nleScenarioDescription || '',
          buildings: formDataFromDb.buildings && Array.isArray(formDataFromDb.buildings)
            ? formDataFromDb.buildings
            : [createEmptyBuilding()],
          activityOverview: formDataFromDb.activityOverview || '',
          fireProtectionDescription: formDataFromDb.fireProtectionDescription || '',
          processUtilities: formDataFromDb.processUtilities || '',
          inspectionDate: formDataFromDb.inspectionDate || '',
          surveyScope: formDataFromDb.surveyScope || '',
          surveyScopeOtherText: formDataFromDb.surveyScopeOtherText || '',
          companySiteBackground: formDataFromDb.companySiteBackground || '',
          occupancyProductsServices: formDataFromDb.occupancyProductsServices || '',
          employeesOperatingHours: formDataFromDb.employeesOperatingHours || '',
          commitmentLossPrevention: formDataFromDb.commitmentLossPrevention || '',
          commitmentLossPrevention_rating: formDataFromDb.commitmentLossPrevention_rating || '',
          fireEquipmentTesting: formDataFromDb.fireEquipmentTesting || '',
          fireEquipmentTesting_rating: formDataFromDb.fireEquipmentTesting_rating || '',
          controlHotWork: formDataFromDb.controlHotWork || '',
          controlHotWork_rating: formDataFromDb.controlHotWork_rating || '',
          electricalMaintenance: formDataFromDb.electricalMaintenance || '',
          electricalMaintenance_rating: formDataFromDb.electricalMaintenance_rating || '',
          generalMaintenance: formDataFromDb.generalMaintenance || '',
          generalMaintenance_rating: formDataFromDb.generalMaintenance_rating || '',
          selfInspections: formDataFromDb.selfInspections || '',
          selfInspections_rating: formDataFromDb.selfInspections_rating || '',
          changeManagement: formDataFromDb.changeManagement || '',
          changeManagement_rating: formDataFromDb.changeManagement_rating || '',
          contractorControls: formDataFromDb.contractorControls || '',
          contractorControls_rating: formDataFromDb.contractorControls_rating || '',
          impairmentHandling: formDataFromDb.impairmentHandling || '',
          impairmentHandling_rating: formDataFromDb.impairmentHandling_rating || '',
          smokingControls: formDataFromDb.smokingControls || '',
          smokingControls_rating: formDataFromDb.smokingControls_rating || '',
          fireSafetyHousekeeping: formDataFromDb.fireSafetyHousekeeping || '',
          fireSafetyHousekeeping_rating: formDataFromDb.fireSafetyHousekeeping_rating || '',
          emergencyResponse: formDataFromDb.emergencyResponse || '',
          emergencyResponse_rating: formDataFromDb.emergencyResponse_rating || '',
          fixedFireProtectionSystems: formDataFromDb.fixedFireProtectionSystems || '',
          fireDetectionAlarmSystems: formDataFromDb.fireDetectionAlarmSystems || '',
          waterSupplies: formDataFromDb.waterSupplies || '',
          businessInterruption: formDataFromDb.businessInterruption || '',
          interdependencies: formDataFromDb.interdependencies || '',
          bcp: formDataFromDb.bcp || '',
          bcp_rating: formDataFromDb.bcp_rating || '',
          allowGenerateDraftRecommendations: formDataFromDb.allowGenerateDraftRecommendations || false,
          reviewerName: formDataFromDb.reviewerName || '',
          reviewerEmail: formDataFromDb.reviewerEmail || '',
          reportStatus: (data.report_status === 'Issue Ready' ? 'Issue Ready' : 'Draft') as 'Draft' | 'Issue Ready',
          industrySector: formDataFromDb.industrySector || '',
          sectionGrades: formDataFromDb.sectionGrades || {
            survey_info: 3,
            property_details: 3,
            construction: 3,
            occupancy: 3,
            management: 3,
            fire_protection: 3,
            business_continuity: 3,
            loss_expectancy: 3,
            hazards: 3,
            natural_hazards: 3,
            recommendations: 3,
            attachments: 3,
          },
          overallGrade: formDataFromDb.overallGrade || 3,
          riskBand: formDataFromDb.riskBand || 'Medium',
        });

        if (formDataFromDb.hazards && Array.isArray(formDataFromDb.hazards)) {
          setHazards(formDataFromDb.hazards);
        }

        if (formDataFromDb.overall_comments && Array.isArray(formDataFromDb.overall_comments)) {
          setOverallComments(formDataFromDb.overall_comments);
        }

        if (formDataFromDb.uploadedFiles && Array.isArray(formDataFromDb.uploadedFiles)) {
          setUploadedFiles(formDataFromDb.uploadedFiles);
        }

        if (formDataFromDb.natural_hazards && Array.isArray(formDataFromDb.natural_hazards)) {
          setNaturalHazards(formDataFromDb.natural_hazards);
        }

        if (data.latitude !== null && data.latitude !== undefined) {
          setLatitude(data.latitude);
        }

        if (data.longitude !== null && data.longitude !== undefined) {
          setLongitude(data.longitude);
        }

        if (data.generated_report) {
          const sections = generateReport(
            {
              ...formDataFromDb,
              propertyName: data.property_name,
              propertyAddress: data.property_address,
              surveyType: data.survey_type as 'Full' | 'Abridged',
            },
            formDataFromDb.hazards || [],
            formDataFromDb.overall_comments || [],
            formDataFromDb.uploadedFiles || []
          ).sections;

          setGeneratedReport({
            sections,
            fullText: data.generated_report,
          });
        }
      }
    } catch (error) {
      console.error('Error loading survey:', error);
    } finally {
      setIsLoadingSurvey(false);
    }
  };

  const handleInputChange = (
    e: React.ChangeEvent<HTMLInputElement | HTMLTextAreaElement | HTMLSelectElement>
  ) => {
    const target = e.target as HTMLInputElement;
    const { name, value, type, checked } = target;
    setFormData((prev) => ({
      ...prev,
      [name]: type === 'checkbox' ? checked : value,
    }));
  };

  const handleSectionGradeChange = (sectionKey: keyof SectionGrades, value: number) => {
    setFormData(prev => ({
      ...prev,
      sectionGrades: {
        ...prev.sectionGrades,
        [sectionKey]: value,
      },
    }));
  };

  const addHazard = () => {
    setHazards([...hazards, { id: crypto.randomUUID(), title: '', description: '', rating: '' }]);
  };

  const removeHazard = (id: string) => {
    if (hazards.length > 1) {
      setHazards(hazards.filter(h => h.id !== id));
    }
  };

  const updateHazard = (id: string, field: keyof Omit<Hazard, 'id'>, value: string) => {
    setHazards(hazards.map(h => h.id === id ? { ...h, [field]: value } : h));
  };

  const addOverallComment = () => {
    setOverallComments([...overallComments, { id: crypto.randomUUID(), hazard: '', description: '', client_response: '', status: '', images: [] }]);
  };

  const removeOverallComment = (id: string) => {
    setOverallComments(overallComments.filter(r => r.id !== id));
  };

  const updateOverallComment = (id: string, field: keyof Omit<OverallComment, 'id'>, value: string) => {
    setOverallComments(overallComments.map(r => {
      if (r.id === id) {
        // Remove auto-generated flag when user edits the recommendation
        const updated = { ...r, [field]: value };
        if (r.isAutoGenerated && (field === 'description' || field === 'hazard')) {
          delete updated.isAutoGenerated;
          delete updated.sourceRatingField;
        }
        return updated;
      }
      return r;
    }));
  };

  const handleRecommendationImageUpload = async (commentId: string, e: React.ChangeEvent<HTMLInputElement>) => {
    const files = e.target.files;
    if (!files || files.length === 0) return;

    const comment = overallComments.find(c => c.id === commentId);
    if (!comment) return;

    const currentImages = comment.images || [];
    if (currentImages.length >= 3) {
      alert('You can only upload up to 3 images per recommendation');
      return;
    }

    const remainingSlots = 3 - currentImages.length;
    const filesToUpload = Array.from(files).slice(0, remainingSlots);

    setIsUploading(true);
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        throw new Error('You must be logged in to upload files');
      }

      const uploadPromises = filesToUpload.map(async (file) => {
        const fileExt = file.name.split('.').pop();
        const fileName = `${crypto.randomUUID()}.${fileExt}`;
        const filePath = `${user.id}/recommendations/${fileName}`;

        const { error: uploadError } = await supabase.storage
          .from('survey-attachments')
          .upload(filePath, file);

        if (uploadError) throw uploadError;

        const { data: { publicUrl } } = supabase.storage
          .from('survey-attachments')
          .getPublicUrl(filePath);

        return publicUrl;
      });

      const newImageUrls = await Promise.all(uploadPromises);

      setOverallComments(overallComments.map(r => {
        if (r.id === commentId) {
          return { ...r, images: [...(r.images || []), ...newImageUrls] };
        }
        return r;
      }));
    } catch (error) {
      console.error('Error uploading recommendation images:', error);
      alert('Failed to upload images. Please try again.');
    } finally {
      setIsUploading(false);
      e.target.value = '';
    }
  };

  const removeRecommendationImage = async (commentId: string, imageUrl: string) => {
    try {
      const urlParts = imageUrl.split('/');
      const filePath = urlParts.slice(-3).join('/');

      const { error } = await supabase.storage
        .from('survey-attachments')
        .remove([filePath]);

      if (error) throw error;

      setOverallComments(overallComments.map(r => {
        if (r.id === commentId) {
          return { ...r, images: (r.images || []).filter(url => url !== imageUrl) };
        }
        return r;
      }));
    } catch (error) {
      console.error('Error removing recommendation image:', error);
      alert('Failed to remove image. Please try again.');
    }
  };

  const updateSumsInsured = (id: string, field: keyof Omit<SumsInsuredRow, 'id'>, value: string) => {
    setSumsInsured(sumsInsured.map(row => row.id === id ? { ...row, [field]: value } : row));
  };

  const updateWorstCasePD = (id: string, field: keyof Omit<WorstCasePDRow, 'id' | 'subtotal'>, value: string) => {
    setWorstCasePD(prev => prev.map(row => {
      if (row.id === id) {
        const updated = { ...row, [field]: value };
        const matchingSumsInsured = sumsInsured.find(si => si.item === row.item);
        const pdValue = parseFloat(matchingSumsInsured?.pd_value || '0');
        const percent = parseFloat(updated.percent || '0');
        updated.subtotal = (pdValue * percent) / 100;
        return updated;
      }
      return row;
    }));
  };

  const updateWorstCaseBI = (id: string, field: keyof Omit<WorstCaseBIRow, 'id' | 'subtotal'>, value: string) => {
    setWorstCaseBI(prev => prev.map(row => {
      if (row.id === id) {
        const updated = { ...row, [field]: value };
        const biValue = parseFloat(businessInterruptionValue || '0');
        const months = parseFloat(updated.months || '0');
        const percent = parseFloat(updated.percent || '0');
        const indemnityPeriodValue = parseFloat(indemnityPeriod || '0');
        updated.subtotal = indemnityPeriodValue > 0 ? (months / indemnityPeriodValue) * (percent / 100) * biValue : 0;
        return updated;
      }
      return row;
    }));
  };

  const addWorstCaseBIRow = () => {
    setWorstCaseBI([...worstCaseBI, {
      id: crypto.randomUUID(),
      item: 'Recovery Phase',
      months: '',
      percent: '',
      subtotal: 0
    }]);
  };

  const removeWorstCaseBIRow = (id: string) => {
    if (worstCaseBI.length > 2) {
      setWorstCaseBI(worstCaseBI.filter(row => row.id !== id));
    }
  };

  const getTotalMonths = () => {
    return worstCaseBI.reduce((sum, row) => sum + (parseFloat(row.months) || 0), 0);
  };

  const calculateWorstCaseTotals = () => {
    const pdTotal = worstCasePD.reduce((sum, row) => sum + row.subtotal, 0);
    const biTotal = worstCaseBI.reduce((sum, row) => sum + row.subtotal, 0);
    return {
      pdTotal,
      biTotal,
      combinedTotal: pdTotal + biTotal
    };
  };

  const updateNleAllRIsPD = (id: string, field: keyof Omit<NLEAllRIsPDRow, 'id' | 'subtotal'>, value: string) => {
    setNleAllRIsPD(prev => prev.map(row => {
      if (row.id === id) {
        const updated = { ...row, [field]: value };
        const matchingSumsInsured = sumsInsured.find(si => si.item === row.item);
        const pdValue = parseFloat(matchingSumsInsured?.pd_value || '0');
        const percent = parseFloat(updated.percent || '0');
        updated.subtotal = (pdValue * percent) / 100;
        return updated;
      }
      return row;
    }));
  };

  const updateNleAllRIsBI = (id: string, field: keyof Omit<NLEAllRIsBIRow, 'id' | 'subtotal'>, value: string) => {
    setNleAllRIsBI(prev => {
      const updated = prev.map(row => {
        if (row.id === id) {
          return { ...row, [field]: value };
        }
        return row;
      });

      const indemnityPeriodValue = parseFloat(indemnityPeriod || '0');
      const biValue = parseFloat(businessInterruptionValue || '0');

      return updated.map(row => {
        const months = parseFloat(row.months || '0');
        const percent = parseFloat(row.percent || '0');
        const subtotal = indemnityPeriodValue > 0 ? (months / indemnityPeriodValue) * (percent / 100) * biValue : 0;
        return { ...row, subtotal };
      });
    });
  };

  const recalculateWorstCaseBISubtotals = () => {
    setWorstCaseBI(prev => {
      const indemnityPeriodValue = parseFloat(indemnityPeriod || '0');
      const biValue = parseFloat(businessInterruptionValue || '0');

      return prev.map(row => {
        const months = parseFloat(row.months || '0');
        const percent = parseFloat(row.percent || '0');
        const subtotal = indemnityPeriodValue > 0 ? (months / indemnityPeriodValue) * (percent / 100) * biValue : 0;
        return { ...row, subtotal };
      });
    });
  };

  const recalculateAllBISubtotals = () => {
    setNleAllRIsBI(prev => {
      const indemnityPeriodValue = parseFloat(indemnityPeriod || '0');
      const biValue = parseFloat(businessInterruptionValue || '0');

      return prev.map(row => {
        const months = parseFloat(row.months || '0');
        const percent = parseFloat(row.percent || '0');
        const subtotal = indemnityPeriodValue > 0 ? (months / indemnityPeriodValue) * (percent / 100) * biValue : 0;
        return { ...row, subtotal };
      });
    });
  };

  useEffect(() => {
    recalculateWorstCaseBISubtotals();
    recalculateAllBISubtotals();
  }, [businessInterruptionValue, indemnityPeriod]);

  const addNleAllRIsBIRow = () => {
    setNleAllRIsBI([...nleAllRIsBI, {
      id: crypto.randomUUID(),
      item: 'Recovery Phase',
      months: '',
      percent: '',
      subtotal: 0
    }]);
  };

  const removeNleAllRIsBIRow = (id: string) => {
    if (nleAllRIsBI.length > 2) {
      setNleAllRIsBI(nleAllRIsBI.filter(row => row.id !== id));
    }
  };

  const getNleAllRIsTotalMonths = () => {
    return nleAllRIsBI.reduce((sum, row) => sum + (parseFloat(row.months) || 0), 0);
  };

  const calculateNleAllRIsTotals = () => {
    const pdTotal = nleAllRIsPD.reduce((sum, row) => sum + row.subtotal, 0);
    const biTotal = nleAllRIsBI.reduce((sum, row) => sum + row.subtotal, 0);
    return {
      pdTotal,
      biTotal,
      combinedTotal: pdTotal + biTotal
    };
  };

  const addNaturalHazard = () => {
    setNaturalHazards([...naturalHazards, {
      id: crypto.randomUUID(),
      hazardType: 'river_flooding',
      description: '',
      rating: ''
    }]);
  };

  const updateNaturalHazard = (id: string, field: keyof Omit<NaturalHazard, 'id'>, value: string) => {
    setNaturalHazards(prev => prev.map(hazard =>
      hazard.id === id ? { ...hazard, [field]: value } : hazard
    ));
  };

  const removeNaturalHazard = (id: string) => {
    setNaturalHazards(naturalHazards.filter(hazard => hazard.id !== id));
  };

  const geocodeAddress = async () => {
    const fullAddress = `${formData.addressLines}, ${formData.townCity}, ${formData.postcode}`.trim();

    if (!fullAddress || fullAddress === ', , ') {
      alert('Please enter a complete address before geocoding.');
      return;
    }

    setIsGeocoding(true);

    try {
      const response = await fetch(
        `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(fullAddress)}&limit=1&addressdetails=1`
      );

      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }

      const data = await response.json();

      if (data && data.length > 0) {
        const lat = parseFloat(data[0].lat);
        const lon = parseFloat(data[0].lon);
        setLatitude(lat);
        setLongitude(lon);
        alert(`Location captured successfully!\nLatitude: ${lat.toFixed(6)}\nLongitude: ${lon.toFixed(6)}`);
      } else {
        alert('Address not found. Please check the address and try again.');
      }
    } catch (error) {
      console.error('Geocoding error:', error);
      alert(`Failed to geocode address: ${error instanceof Error ? error.message : 'Unknown error'}`);
    } finally {
      setIsGeocoding(false);
    }
  };

  const handleMapLocationChange = (lat: number, lng: number) => {
    setLatitude(lat);
    setLongitude(lng);
  };

  const addBuilding = () => {
    setFormData(prev => ({
      ...prev,
      buildings: [...prev.buildings, createEmptyBuilding()],
    }));
  };

  const removeBuilding = (id: string) => {
    if (formData.buildings.length > 1) {
      setFormData(prev => ({
        ...prev,
        buildings: prev.buildings.filter(b => b.id !== id),
      }));
    }
  };

  const updateBuilding = (id: string, updates: Partial<Building>) => {
    setFormData(prev => ({
      ...prev,
      buildings: prev.buildings.map(b => b.id === id ? { ...b, ...updates } : b),
    }));
  };

  const updateBuildingConstruction = (
    buildingId: string,
    type: 'walls' | 'roof_ceiling',
    field: keyof BuildingConstruction,
    value: number
  ) => {
    setFormData(prev => ({
      ...prev,
      buildings: prev.buildings.map(b =>
        b.id === buildingId
          ? {
              ...b,
              construction: {
                ...b.construction,
                [type]: {
                  ...b.construction[type],
                  [field]: value,
                },
              },
            }
          : b
      ),
    }));
  };

  const updateBuildingFireProtection = (
    buildingId: string,
    field: 'sprinkler_coverage_pct' | 'detection_coverage_pct',
    value: number
  ) => {
    setFormData(prev => ({
      ...prev,
      buildings: prev.buildings.map(b =>
        b.id === buildingId
          ? {
              ...b,
              fire_protection: {
                ...b.fire_protection,
                [field]: value,
              },
            }
          : b
      ),
    }));
  };

  const handleFileUpload = async (e: React.ChangeEvent<HTMLInputElement>, type: 'photo' | 'site-plan') => {
    const files = e.target.files;
    if (!files || files.length === 0) return;

    setIsUploading(true);
    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) {
        throw new Error('You must be logged in to upload files');
      }

      const uploadPromises = Array.from(files).map(async (file) => {
        const fileExt = file.name.split('.').pop();
        const fileName = `${crypto.randomUUID()}.${fileExt}`;
        const filePath = `${user.id}/${fileName}`;

        const { error: uploadError } = await supabase.storage
          .from('survey-attachments')
          .upload(filePath, file);

        if (uploadError) throw uploadError;

        const { data: { publicUrl } } = supabase.storage
          .from('survey-attachments')
          .getPublicUrl(filePath);

        return {
          id: crypto.randomUUID(),
          name: file.name,
          url: publicUrl,
          type
        };
      });

      const newFiles = await Promise.all(uploadPromises);
      setUploadedFiles([...uploadedFiles, ...newFiles]);
    } catch (error) {
      console.error('Error uploading files:', error);
      alert('Failed to upload files. Please try again.');
    } finally {
      setIsUploading(false);
      e.target.value = '';
    }
  };

  const removeFile = async (fileId: string, fileUrl: string) => {
    try {
      const urlParts = fileUrl.split('/');
      const filePath = urlParts.slice(-2).join('/');

      const { error } = await supabase.storage
        .from('survey-attachments')
        .remove([filePath]);

      if (error) throw error;

      setUploadedFiles(uploadedFiles.filter(f => f.id !== fileId));
    } catch (error) {
      console.error('Error removing file:', error);
      alert('Failed to remove file. Please try again.');
    }
  };

  const handleRegenerateSection = async (sectionId: SectionId) => {
    if (!generatedReport || !currentSurveyId) return;

    const regeneratedSection = generateSection(sectionId, formData, hazards, overallComments, uploadedFiles);

    const updatedSections = generatedReport.sections.map(section =>
      section.id === sectionId ? regeneratedSection : section
    );

    let fullText = `DRAFT SURVEY REPORT (AI GENERATED)

PROPERTY & FIRE RISK SURVEY REPORT

${formData.propertyName || 'Property Name Not Provided'}
${formData.propertyAddress || 'Address Not Provided'}

Report Date: ${new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' })}


`;

    updatedSections.forEach((section, index) => {
      fullText += `\n\n`;
      fullText += `[${section.id}] ${index + 1}. ${section.title.toUpperCase()}\n\n`;
      fullText += section.content;
      fullText += `\n`;
    });

    fullText += `\n\n`;
    fullText += `END OF DRAFT REPORT\n`;

    setGeneratedReport({ sections: updatedSections, fullText });

    try {
      const { data: { user } } = await supabase.auth.getUser();
      if (!user) return;

      await supabase
        .from('survey_reports')
        .update({
          generated_report: fullText,
          form_data: { ...formData, hazards, overall_comments: overallComments, uploadedFiles },
        })
        .eq('id', currentSurveyId)
        .eq('user_id', user.id);
    } catch (error) {
      console.error('Error saving regenerated report:', error);
    }
  };

  const handleSaveSurvey = async () => {
    setIsSaving(true);
    setSaveStatus('idle');
    setSaveErrorMessage('');

    try {
      const { data: { user } } = await supabase.auth.getUser();

      if (!user) {
        throw new Error('You must be logged in to save a survey');
      }

      const combinedAddress = [
        formData.addressLines,
        formData.townCity,
        formData.postcode,
        formData.country
      ].filter(Boolean).join(', ');

      const surveyYear = getSurveyYear(formData.surveyDate, formData.issueDate);
      const commentsWithRefNumbers = ensureReferenceNumbers(overallComments, surveyYear);
      setOverallComments(commentsWithRefNumbers);

      const surveyData = {
        property_name: formData.propertyName,
        property_address: combinedAddress,
        company_name: formData.companyName,
        survey_date: formData.surveyDate,
        form_data: { ...formData, hazards, overall_comments: commentsWithRefNumbers, natural_hazards: naturalHazards, uploadedFiles },
        latitude: latitude,
        longitude: longitude,
        user_id: user.id,
      };

      if (currentSurveyId) {
        const { error } = await supabase
          .from('survey_reports')
          .update({
            property_name: surveyData.property_name,
            property_address: surveyData.property_address,
            company_name: surveyData.company_name,
            survey_date: surveyData.survey_date,
            form_data: surveyData.form_data,
            latitude: surveyData.latitude,
            longitude: surveyData.longitude,
            report_status: formData.reportStatus,
          })
          .eq('id', currentSurveyId)
          .eq('user_id', user.id);

        if (error) throw error;

        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        setLastSaved(timeString);
        setSaveStatus('success');
        setTimeout(() => setSaveStatus('idle'), 3000);
      } else {
        const { data, error } = await supabase
          .from('survey_reports')
          .insert({
            ...surveyData,
            generated_report: null,
            report_status: formData.reportStatus,
          })
          .select('id')
          .single();

        if (error) throw error;

        if (data) {
          setCurrentSurveyId(data.id);
        }

        const now = new Date();
        const timeString = now.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        setLastSaved(timeString);
        setSaveStatus('success');
        setTimeout(() => setSaveStatus('idle'), 3000);
      }
    } catch (error: any) {
      setSaveStatus('error');
      setSaveErrorMessage(error.message || 'Failed to save survey');
    } finally {
      setIsSaving(false);
    }
  };

  const handleSubmit = async (e: React.FormEvent) => {
    e.preventDefault();
    setIsSubmitting(true);
    setSubmitStatus('idle');
    setErrorMessage('');

    try {
      const { data: { user } } = await supabase.auth.getUser();

      if (!user) {
        throw new Error('You must be logged in to submit a survey report');
      }

      const combinedAddress = [
        formData.addressLines,
        formData.townCity,
        formData.postcode,
        formData.country
      ].filter(Boolean).join(', ');

      const reportData = {
        property_name: formData.propertyName,
        property_address: combinedAddress,
        form_data: { ...formData, hazards, overall_comments: overallComments, uploadedFiles },
        user_id: user.id,
      };

      let surveyIdToUse = currentSurveyId;

      if (currentSurveyId) {
        const { error } = await supabase
          .from('survey_reports')
          .update({
            property_name: reportData.property_name,
            property_address: reportData.property_address,
            form_data: reportData.form_data,
            report_status: formData.reportStatus,
          })
          .eq('id', currentSurveyId)
          .eq('user_id', user.id);

        if (error) throw error;
      } else {
        const { data, error } = await supabase
          .from('survey_reports')
          .insert({
            ...reportData,
            generated_report: null,
            report_status: formData.reportStatus,
          })
          .select('id')
          .single();

        if (error) throw error;

        if (data) {
          surveyIdToUse = data.id;
          setCurrentSurveyId(data.id);
        }
      }

      const { data: savedSurvey, error: fetchError } = await supabase
        .from('survey_reports')
        .select('form_data')
        .eq('id', surveyIdToUse)
        .maybeSingle();

      if (fetchError) throw fetchError;

      if (savedSurvey && savedSurvey.form_data) {
        const dbFormData = savedSurvey.form_data;

        const report = generateReport(
          {
            ...dbFormData,
            propertyName: reportData.property_name,
            propertyAddress: reportData.property_address,
            surveyType: surveyType,
          },
          dbFormData.hazards || [],
          dbFormData.overall_comments || [],
          dbFormData.uploadedFiles || []
        );

        const { error: updateError } = await supabase
          .from('survey_reports')
          .update({
            generated_report: report.fullText,
          })
          .eq('id', surveyIdToUse)
          .eq('user_id', user.id);

        if (updateError) throw updateError;

        setGeneratedReport(report);
      }

      setSubmitStatus('success');
      setTimeout(() => {
        setSubmitStatus('idle');
      }, 3000);
    } catch (error: any) {
      setSubmitStatus('error');
      setErrorMessage(error.message || 'Failed to submit survey report');
    } finally {
      setIsSubmitting(false);
    }
  };

  const getSectionNumber = (fullSectionNumber: number): number => {
    if (surveyType === 'Full') return fullSectionNumber;
    if (fullSectionNumber <= 5) return fullSectionNumber;
    return fullSectionNumber - 4;
  };

  const getSectionCompletion = () => {
    const hasValue = (val: any): boolean => {
      if (typeof val === 'string') return val.trim().length > 0;
      if (typeof val === 'boolean') return val;
      if (typeof val === 'number') return val > 0;
      if (Array.isArray(val)) return val.length > 0;
      return false;
    };

    return [
      { name: 'Survey Info', isComplete: hasValue(formData.inspectionDate) || hasValue(formData.surveyScope) },
      { name: 'Property Details', isComplete: hasValue(formData.propertyName) || hasValue(formData.addressLines) },
      { name: 'Construction', isComplete: formData.buildings.length > 0 && (hasValue(formData.buildings[0].building_name) || hasValue(formData.buildings[0].year_built)) },
      { name: 'Occupancy', isComplete: hasValue(formData.primaryOccupancy) || hasValue(formData.activityOverview) },
      { name: 'Management', isComplete: hasValue(formData.commitmentLossPrevention) || hasValue(formData.fireEquipmentTesting) },
      { name: 'Fire Protection', isComplete: hasValue(formData.fixedFireProtectionSystems) || hasValue(formData.fireDetectionAlarmSystems) },
      { name: 'Business Continuity', isComplete: hasValue(formData.businessInterruption) || hasValue(formData.bcp) },
      { name: 'Loss Expectancy', isComplete: sumsInsured.some(row => hasValue(row.pd_value)) || hasValue(businessInterruptionValue) || worstCasePD.some(row => hasValue(row.percent)) || worstCaseBI.some(row => hasValue(row.months) || hasValue(row.percent)) },
      { name: 'Hazards', isComplete: hazards.some(h => hasValue(h.title) || hasValue(h.description)) },
      { name: 'Recommendations', isComplete: overallComments.some(r => hasValue(r.hazard) || hasValue(r.description)) },
      { name: 'Attachments', isComplete: uploadedFiles.length > 0 },
    ];
  };

  const handleViewDraft = () => {
    if (generatedReport) {
      setIsDraftModalOpen(true);
    } else {
      const report = generateReport({ ...formData, surveyType }, hazards, overallComments, uploadedFiles);
      setGeneratedReport(report);
      setIsDraftModalOpen(true);
    }
  };

  const handleDownloadReport = () => {
    if (!generatedReport) return;

    const blob = new Blob([generatedReport.fullText], { type: 'text/plain' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${formData.propertyName || 'survey'}-report.txt`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  };

  if (isLoadingSurvey) {
    return (
      <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100 flex items-center justify-center">
        <div className="text-center">
          <div className="animate-spin rounded-full h-16 w-16 border-4 border-slate-300 border-t-slate-900 mx-auto mb-4"></div>
          <p className="text-slate-600 text-lg">Loading survey...</p>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-gradient-to-br from-slate-50 to-slate-100">
      <ProgressBar sections={getSectionCompletion()} />

      <div className="max-w-4xl mx-auto px-4 py-12 pb-32">
        <div className="mb-12 text-center">
          <h1 className="text-5xl font-bold text-slate-900 mb-3">ClearRisk - Survey Report Input Form</h1>
          <p className="text-lg text-slate-600">Structured input to generate a professional draft survey report.</p>
        </div>

        {isIssued && (
          <div className="mb-6 bg-amber-50 border-l-4 border-amber-400 p-6 rounded-r-lg">
            <div className="flex items-start gap-3">
              <Lock className="w-6 h-6 text-amber-600 flex-shrink-0 mt-0.5" />
              <div>
                <h3 className="text-lg font-bold text-amber-900 mb-1">THIS REPORT HAS BEEN ISSUED AND IS READ-ONLY</h3>
                <p className="text-sm text-amber-800">
                  This report has been officially issued and cannot be edited or deleted. All form fields are locked to preserve the integrity of the issued document.
                  If you need to make changes, please create a new survey by using the "Resurvey Site" option from the dashboard.
                </p>
              </div>
            </div>
          </div>
        )}

        {externalEditActive && (
          <div className="bg-amber-50 border-2 border-amber-400 rounded-lg p-4 mb-6">
            <div className="flex items-start">
              <AlertCircle className="w-6 h-6 text-amber-600 mr-3 flex-shrink-0 mt-0.5" />
              <div>
                <h3 className="text-lg font-semibold text-amber-900 mb-1">External Contributor Currently Editing</h3>
                <p className="text-sm text-amber-800">
                  An external contributor is currently working on this survey. Your changes and their changes may conflict.
                  Please coordinate with the external party before making edits to avoid data loss.
                </p>
              </div>
            </div>
          </div>
        )}

        <form onSubmit={handleSubmit} className="space-y-6">
          <div className="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
            <h2 className="text-2xl font-semibold text-slate-900 mb-6 pb-3 border-b border-slate-200">
              Section 1: Survey Information
            </h2>
            <div className="space-y-4">
              {formData.referenceNumber && (
                <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                  <label className="block text-sm font-medium text-slate-700 mb-2">
                    Reference Number
                  </label>
                  <div className="text-lg font-semibold text-slate-900 tracking-wide">
                    {formData.referenceNumber}
                  </div>
                  <p className="text-xs text-slate-500 mt-1">System-generated reference (read-only)</p>
                </div>
              )}

              <div>
                <label htmlFor="inspectionDate" className="block text-sm font-medium text-slate-700 mb-2">
                  Inspection Date *
                </label>
                <input
                  type="date"
                  id="inspectionDate"
                  name="inspectionDate"
                  required
                  value={formData.inspectionDate}
                  onChange={handleInputChange}
                  className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all"
                />
              </div>

              <div>
                <label htmlFor="industrySector" className="block text-sm font-medium text-slate-700 mb-2">
                  Industry Sector *
                </label>
                <select
                  id="industrySector"
                  name="industrySector"
                  required
                  value={formData.industrySector || ''}
                  onChange={handleInputChange}
                  disabled={isIssued}
                  className={`w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all ${
                    isIssued ? 'bg-slate-100 cursor-not-allowed' : ''
                  }`}
                >
                  <option value="">Select industry sector</option>
                  {['Food & Beverage', 'Foundry / Metal', 'Chemical / ATEX', 'Logistics / Warehouse', 'Office / Commercial', 'General Industrial', 'Other'].map(sector => {
                    const weighting = sectorWeightings.find(w => w.sector_name === sector);
                    const isCustom = weighting?.is_custom || false;
                    return (
                      <option key={sector} value={sector}>
                        {sector}{isCustom ? ' *' : ''}
                      </option>
                    );
                  })}
                </select>
                <p className="text-xs text-slate-500 mt-1.5 italic">
                  The selected sector adjusts risk score weightings to reflect typical loss drivers for this industry.
                  {sectorWeightings.some(w => w.is_custom) && (
                    <span className="block mt-1 text-blue-700">* Custom weightings configured by admin</span>
                  )}
                </p>
                {formData.industrySector && (() => {
                  const sectorInfo: Record<string, { emphasis: string[] }> = {
                    'Food & Beverage': { emphasis: ['Construction & Combustibility (High)', 'Fire Protection (High)', 'Detection Systems (Medium)'] },
                    'Foundry / Metal': { emphasis: ['Management Systems (High)', 'Fire Protection (Medium)', 'Special Hazards (Medium)'] },
                    'Chemical / ATEX': { emphasis: ['Fire Protection (High)', 'Special Hazards (High)', 'Management Systems (High)'] },
                    'Logistics / Warehouse': { emphasis: ['Fire Protection (Very High)', 'Construction & Combustibility (High)', 'Detection Systems (Medium)'] },
                    'Office / Commercial': { emphasis: ['Business Interruption (High)', 'Detection Systems (Medium)', 'Fire Protection (Medium)'] },
                    'General Industrial': { emphasis: ['Construction & Combustibility (Medium)', 'Fire Protection (Medium)', 'Management Systems (Medium)'] },
                    'Other': { emphasis: ['Construction & Combustibility (Medium)', 'Fire Protection (Medium)', 'All other factors equally weighted'] },
                  };
                  const info = sectorInfo[formData.industrySector];
                  if (!info) return null;
                  return (
                    <div className="mt-3 p-3 bg-blue-50 border border-blue-200 rounded-lg">
                      <p className="text-sm font-medium text-blue-900 mb-1.5">This sector emphasises:</p>
                      <ul className="text-xs text-blue-800 space-y-0.5">
                        {(info.emphasis || []).map((item, idx) => (
                          <li key={idx}> {item}</li>
                        ))}
                      </ul>
                    </div>
                  );
                })()}
              </div>

              <div>
                <label className="block text-sm font-medium text-slate-700 mb-3">
                  Survey Scope *
                </label>
                <div className="space-y-2.5">
                  <label className="flex items-center space-x-3 cursor-pointer">
                    <input
                      type="radio"
                      name="surveyScope"
                      value="full-site"
                      checked={formData.surveyScope === 'full-site'}
                      onChange={handleInputChange}
                      required
                      className="w-4 h-4 text-slate-600 border-slate-300 focus:ring-2 focus:ring-slate-500"
                    />
                    <span className="text-slate-700">Full site survey</span>
                  </label>
                  <label className="flex items-center space-x-3 cursor-pointer">
                    <input
                      type="radio"
                      name="surveyScope"
                      value="limited-areas"
                      checked={formData.surveyScope === 'limited-areas'}
                      onChange={handleInputChange}
                      className="w-4 h-4 text-slate-600 border-slate-300 focus:ring-2 focus:ring-slate-500"
                    />
                    <span className="text-slate-700">Limited areas accessed</span>
                  </label>
                  <label className="flex items-center space-x-3 cursor-pointer">
                    <input
                      type="radio"
                      name="surveyScope"
                      value="desktop-review"
                      checked={formData.surveyScope === 'desktop-review'}
                      onChange={handleInputChange}
                      className="w-4 h-4 text-slate-600 border-slate-300 focus:ring-2 focus:ring-slate-500"
                    />
                    <span className="text-slate-700">Desktop review / recommendation update</span>
                  </label>
                  <label className="flex items-center space-x-3 cursor-pointer">
                    <input
                      type="radio"
                      name="surveyScope"
                      value="other"
                      checked={formData.surveyScope === 'other'}
                      onChange={handleInputChange}
                      className="w-4 h-4 text-slate-600 border-slate-300 focus:ring-2 focus:ring-slate-500"
                    />
                    <span className="text-slate-700">Other</span>
                  </label>
                  {formData.surveyScope === 'other' && (
                    <input
                      type="text"
                      name="surveyScopeOtherText"
                      value={formData.surveyScopeOtherText}
                      onChange={handleInputChange}
                      required
                      className="w-full ml-7 px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all"
                      placeholder="Please specify"
                    />
                  )}
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label htmlFor="surveyorName" className="block text-sm font-medium text-slate-700 mb-2">
                    Surveyor Name *
                  </label>
                  <input
                    type="text"
                    id="surveyorName"
                    name="surveyorName"
                    required
                    value={formData.surveyorName}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all"
                    placeholder="Enter surveyor name"
                  />
                </div>

                <div>
                  <label htmlFor="surveyorCompanyName" className="block text-sm font-medium text-slate-700 mb-2">
                    Surveyor Company Name *
                  </label>
                  <input
                    type="text"
                    id="surveyorCompanyName"
                    name="surveyorCompanyName"
                    required
                    value={formData.surveyorCompanyName}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all"
                    placeholder="Enter surveyor company name"
                  />
                </div>

                <div>
                  <label htmlFor="companyName" className="block text-sm font-medium text-slate-700 mb-2">
                    Company Name *
                  </label>
                  <input
                    type="text"
                    id="companyName"
                    name="companyName"
                    required
                    value={formData.companyName}
                    onChange={handleInputChange}
                    disabled={isIssued}
                    className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all disabled:bg-slate-100 disabled:cursor-not-allowed"
                    placeholder="Enter company name"
                  />
                </div>

                <div>
                  <label htmlFor="surveyDate" className="block text-sm font-medium text-slate-700 mb-2">
                    Survey Date *
                  </label>
                  <input
                    type="date"
                    id="surveyDate"
                    name="surveyDate"
                    required
                    value={formData.surveyDate}
                    onChange={handleInputChange}
                    disabled={isIssued}
                    className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all disabled:bg-slate-100 disabled:cursor-not-allowed"
                  />
                </div>
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label htmlFor="siteContact" className="block text-sm font-medium text-slate-700 mb-2">
                    Site Contact *
                  </label>
                  <input
                    type="text"
                    id="siteContact"
                    name="siteContact"
                    required
                    value={formData.siteContact}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all"
                    placeholder="Enter site contact name"
                  />
                </div>

                <div>
                  <label className="block text-sm font-medium text-slate-700 mb-2">
                    Discussions on site with *
                  </label>
                  <div className="space-y-2">
                    {formData.discussionsOnSite.map((discussion, index) => (
                      <div key={index} className="flex gap-2">
                        <input
                          type="text"
                          value={discussion}
                          onChange={(e) => {
                            const newDiscussions = [...formData.discussionsOnSite];
                            newDiscussions[index] = e.target.value;
                            setFormData({ ...formData, discussionsOnSite: newDiscussions });
                          }}
                          required
                          className="flex-1 px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all"
                          placeholder="e.g., Facilities Manager, Site Engineer"
                        />
                        {formData.discussionsOnSite.length > 1 && (
                          <button
                            type="button"
                            onClick={() => {
                              const newDiscussions = formData.discussionsOnSite.filter((_, i) => i !== index);
                              setFormData({ ...formData, discussionsOnSite: newDiscussions });
                            }}
                            className="px-3 py-2 text-red-600 hover:text-red-700 transition-colors"
                          >
                            <Trash2 size={18} />
                          </button>
                        )}
                      </div>
                    ))}
                    <button
                      type="button"
                      onClick={() => {
                        setFormData({ ...formData, discussionsOnSite: [...formData.discussionsOnSite, ''] });
                      }}
                      className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors"
                    >
                      <Plus size={16} />
                      Add Another Contact
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div className="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
            <h2 className="text-2xl font-semibold text-slate-900 mb-6 pb-3 border-b border-slate-200">
              Section 2: Location Summary
            </h2>
            <div className="space-y-4">
              <div>
                <label htmlFor="propertyName" className="block text-sm font-medium text-slate-700 mb-2">
                  Property Name / Reference *
                </label>
                <input
                  type="text"
                  id="propertyName"
                  name="propertyName"
                  required
                  value={formData.propertyName}
                  onChange={handleInputChange}
                  className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all"
                  placeholder="Enter property name or reference"
                />
              </div>

              <div>
                <label htmlFor="addressLines" className="block text-sm font-medium text-slate-700 mb-2">
                  Address *
                </label>
                <textarea
                  id="addressLines"
                  name="addressLines"
                  required
                  value={formData.addressLines}
                  onChange={handleInputChange}
                  rows={2}
                  className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all resize-none"
                  placeholder="Street address, building number"
                />
              </div>

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label htmlFor="townCity" className="block text-sm font-medium text-slate-700 mb-2">
                    Town / City *
                  </label>
                  <input
                    type="text"
                    id="townCity"
                    name="townCity"
                    required
                    value={formData.townCity}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all"
                    placeholder="Enter town or city"
                  />
                </div>

                <div>
                  <label htmlFor="postcode" className="block text-sm font-medium text-slate-700 mb-2">
                    Postcode / ZIP Code *
                  </label>
                  <input
                    type="text"
                    id="postcode"
                    name="postcode"
                    required
                    value={formData.postcode}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all"
                    placeholder="Enter postcode or ZIP code"
                  />
                </div>
              </div>

              <div>
                <label htmlFor="country" className="block text-sm font-medium text-slate-700 mb-2">
                  Country *
                </label>
                <select
                  id="country"
                  name="country"
                  required
                  value={formData.country}
                  onChange={handleInputChange}
                  className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all bg-white"
                >
                  <option value="">Select a country</option>
                  <option value="United Kingdom">United Kingdom</option>
                  <option value="United States">United States</option>
                  <option value="Canada">Canada</option>
                  <option value="Australia">Australia</option>
                  <option value="New Zealand">New Zealand</option>
                  <option value="Ireland">Ireland</option>
                  <option value="Germany">Germany</option>
                  <option value="France">France</option>
                  <option value="Italy">Italy</option>
                  <option value="Spain">Spain</option>
                  <option value="Netherlands">Netherlands</option>
                  <option value="Belgium">Belgium</option>
                  <option value="Switzerland">Switzerland</option>
                  <option value="Austria">Austria</option>
                  <option value="Denmark">Denmark</option>
                  <option value="Sweden">Sweden</option>
                  <option value="Norway">Norway</option>
                  <option value="Finland">Finland</option>
                  <option value="Poland">Poland</option>
                  <option value="Czech Republic">Czech Republic</option>
                  <option value="Portugal">Portugal</option>
                  <option value="Greece">Greece</option>
                  <option value="Luxembourg">Luxembourg</option>
                  <option value="Iceland">Iceland</option>
                  <option value="Japan">Japan</option>
                  <option value="South Korea">South Korea</option>
                  <option value="Singapore">Singapore</option>
                  <option value="Hong Kong">Hong Kong</option>
                  <option value="Taiwan">Taiwan</option>
                  <option value="Israel">Israel</option>
                  <option value="United Arab Emirates">United Arab Emirates</option>
                  <option value="Qatar">Qatar</option>
                  <option value="Saudi Arabia">Saudi Arabia</option>
                  <option value="China">China</option>
                  <option value="India">India</option>
                  <option value="Brazil">Brazil</option>
                  <option value="Mexico">Mexico</option>
                  <option value="Argentina">Argentina</option>
                  <option value="Chile">Chile</option>
                  <option value="South Africa">South Africa</option>
                  <option value="Russia">Russia</option>
                  <option value="Turkey">Turkey</option>
                  <option value="Malaysia">Malaysia</option>
                  <option value="Thailand">Thailand</option>
                  <option value="Indonesia">Indonesia</option>
                  <option value="Philippines">Philippines</option>
                  <option value="Vietnam">Vietnam</option>
                  <option value="Other">Other</option>
                </select>
              </div>

              <div className="bg-slate-50 border border-slate-200 rounded-lg p-4">
                <div className="flex items-start justify-between gap-4">
                  <div className="flex-1">
                    <div className="flex items-center gap-2 mb-2">
                      <MapPin className="w-5 h-5 text-slate-600" />
                      <h3 className="text-sm font-semibold text-slate-900">GPS Location</h3>
                    </div>
                    {latitude !== null && longitude !== null ? (
                      <div className="text-sm text-slate-700">
                        <p><span className="font-medium">Latitude:</span> {latitude.toFixed(6)}</p>
                        <p><span className="font-medium">Longitude:</span> {longitude.toFixed(6)}</p>
                      </div>
                    ) : (
                      <p className="text-sm text-slate-600">No location captured yet</p>
                    )}
                  </div>
                  <button
                    type="button"
                    onClick={geocodeAddress}
                    disabled={isGeocoding}
                    className="flex items-center gap-2 px-4 py-2 text-sm font-medium text-white bg-slate-700 rounded-lg hover:bg-slate-800 disabled:bg-slate-400 disabled:cursor-not-allowed transition-colors"
                  >
                    <MapPin className="w-4 h-4" />
                    {isGeocoding ? 'Capturing...' : 'Capture GPS'}
                  </button>
                </div>
              </div>

              {latitude !== null && longitude !== null && (
                <div>
                  <div className="mb-2">
                    <h3 className="text-sm font-medium text-slate-700">
                      Confirm Location on Map
                    </h3>
                    <p className="text-xs text-slate-600 mt-1">
                      Drag the marker or click on the map to adjust the location if needed
                    </p>
                  </div>
                  <GpsMap
                    latitude={latitude}
                    longitude={longitude}
                    onLocationChange={handleMapLocationChange}
                  />
                </div>
              )}

              <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                  <label htmlFor="propertyType" className="block text-sm font-medium text-slate-700 mb-2">
                    Property Type *
                  </label>
                  <select
                    id="propertyType"
                    name="propertyType"
                    required
                    value={formData.propertyType}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all bg-white"
                  >
                    <option value="">Select property type</option>
                    <option value="Aircraft Assembly">Aircraft Assembly</option>
                    <option value="Aircraft Maintenance">Aircraft Maintenance</option>
                    <option value="Aircraft Painting">Aircraft Painting</option>
                    <option value="Aluminium">Aluminium</option>
                    <option value="Auto Assembly">Auto Assembly</option>
                    <option value="Auto Body">Auto Body</option>
                    <option value="Auto Paint">Auto Paint</option>
                    <option value="Auto Press">Auto Press</option>
                    <option value="Chemical">Chemical</option>
                    <option value="Data Centre">Data Centre</option>
                    <option value="Electrical Equipment Assembly">Electrical Equipment Assembly</option>
                    <option value="Expanded Plastics">Expanded Plastics</option>
                    <option value="Food & Beverage">Food & Beverage</option>
                    <option value="Foundry and Forge">Foundry and Forge</option>
                    <option value="Glass Manufacturing">Glass Manufacturing</option>
                    <option value="Hospital">Hospital</option>
                    <option value="Hotel">Hotel</option>
                    <option value="Machine shops">Machine shops</option>
                    <option value="Mining">Mining</option>
                    <option value="Mixed use">Mixed use</option>
                    <option value="Office">Office</option>
                    <option value="Other">Other</option>
                    <option value="Paper">Paper</option>
                    <option value="Pharmaceutical">Pharmaceutical</option>
                    <option value="Power Generation">Power Generation</option>
                    <option value="Printing">Printing</option>
                    <option value="Retail">Retail</option>
                    <option value="Residential">Residential</option>
                    <option value="Semiconductor">Semiconductor</option>
                    <option value="Sheet Metal Working">Sheet Metal Working</option>
                    <option value="Ship Building">Ship Building</option>
                    <option value="Steel Mill">Steel Mill</option>
                    <option value="Textiles">Textiles</option>
                    <option value="Unexpanded Plastics">Unexpanded Plastics</option>
                    <option value="Vacant Plants">Vacant Plants</option>
                    <option value="Warehouse - Ceiling sprinklers only">Warehouse - Ceiling sprinklers only</option>
                    <option value="Waste Industry">Waste Industry</option>
                    <option value="Woodworking">Woodworking</option>
                  </select>
                </div>

                <div>
                  <label htmlFor="primaryOccupancy" className="block text-sm font-medium text-slate-700 mb-2">
                    Primary Occupancy / Use *
                  </label>
                  <input
                    type="text"
                    id="primaryOccupancy"
                    name="primaryOccupancy"
                    required
                    value={formData.primaryOccupancy}
                    onChange={handleInputChange}
                    className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all"
                    placeholder="Enter primary occupancy or use"
                  />
                </div>
              </div>
            </div>
          </div>

          <BuildingForm
            buildings={formData.buildings}
            onAddBuilding={addBuilding}
            onRemoveBuilding={removeBuilding}
            onUpdateBuilding={updateBuilding}
            onUpdateConstruction={updateBuildingConstruction}
            onUpdateFireProtection={updateBuildingFireProtection}
          />

          <div className="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
            <h2 className="text-2xl font-semibold text-slate-900 mb-6 pb-3 border-b border-slate-200">
              Section 4: Occupancy Description
            </h2>
            <div className="space-y-4">
              <div>
                <label htmlFor="companySiteBackground" className="block text-sm font-medium text-slate-700 mb-2">
                  Company / Site Background *
                </label>
                <textarea
                  id="companySiteBackground"
                  name="companySiteBackground"
                  required
                  value={formData.companySiteBackground}
                  onChange={handleInputChange}
                  rows={4}
                  className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all resize-none"
                  placeholder="Describe the company and site background"
                />
              </div>

              <div>
                <label htmlFor="occupancyProductsServices" className="block text-sm font-medium text-slate-700 mb-2">
                  Occupancy / Products / Services *
                </label>
                <textarea
                  id="occupancyProductsServices"
                  name="occupancyProductsServices"
                  required
                  value={formData.occupancyProductsServices}
                  onChange={handleInputChange}
                  rows={4}
                  className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all resize-none"
                  placeholder="Describe occupancy, products, and services"
                />
              </div>

              <div>
                <label htmlFor="processUtilities" className="block text-sm font-medium text-slate-700 mb-2">
                  Process Utilities
                </label>
                <textarea
                  id="processUtilities"
                  name="processUtilities"
                  value={formData.processUtilities}
                  onChange={handleInputChange}
                  rows={8}
                  className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all resize-y"
                  placeholder="Describe process utilities including:&#10; Gas&#10; Steam&#10; Compressed air&#10; Dust extraction&#10; Refrigeration&#10; Other utilities"
                />
              </div>

              <div>
                <label htmlFor="employeesOperatingHours" className="block text-sm font-medium text-slate-700 mb-2">
                  Employees / Operating Hours *
                </label>
                <input
                  type="text"
                  id="employeesOperatingHours"
                  name="employeesOperatingHours"
                  required
                  value={formData.employeesOperatingHours}
                  onChange={handleInputChange}
                  className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all"
                  placeholder="e.g., 50 employees, operates 24/7"
                />
              </div>
            </div>
          </div>

          <div className="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
            <h2 className="text-2xl font-semibold text-slate-900 mb-6 pb-3 border-b border-slate-200">
              Section 5: Management Systems
            </h2>
            <div className="grid grid-cols-1 lg:grid-cols-2 gap-6">
              <div className="space-y-6">
                <h3 className="text-lg font-semibold text-slate-900 pb-2 border-b border-slate-300">
                  Fire Safety & Housekeeping
                </h3>

                <div className="space-y-4">
                  <div>
                    <label htmlFor="commitmentLossPrevention" className="block text-sm font-medium text-slate-700 mb-2">
                      Commitment to loss prevention
                    </label>
                    <RatingRadio
                      value={formData.commitmentLossPrevention_rating}
                      onChange={(value) => setFormData(prev => ({ ...prev, commitmentLossPrevention_rating: value }))}
                    />
                    <input
                      type="text"
                      id="commitmentLossPrevention"
                      name="commitmentLossPrevention"
                      value={formData.commitmentLossPrevention}
                      onChange={handleInputChange}
                      className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all mt-2"
                      placeholder="Describe commitment to loss prevention"
                    />
                  </div>

                  <div>
                    <label htmlFor="fireEquipmentTesting" className="block text-sm font-medium text-slate-700 mb-2">
                      Fire equipment testing & maintenance
                    </label>
                    <RatingRadio
                      value={formData.fireEquipmentTesting_rating}
                      onChange={(value) => setFormData(prev => ({ ...prev, fireEquipmentTesting_rating: value }))}
                    />
                    <input
                      type="text"
                      id="fireEquipmentTesting"
                      name="fireEquipmentTesting"
                      value={formData.fireEquipmentTesting}
                      onChange={handleInputChange}
                      className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all mt-2"
                      placeholder="Describe fire equipment testing and maintenance"
                    />
                  </div>

                  <div>
                    <label htmlFor="controlHotWork" className="block text-sm font-medium text-slate-700 mb-2">
                      Control of hot work
                    </label>
                    <RatingRadio
                      value={formData.controlHotWork_rating}
                      onChange={(value) => setFormData(prev => ({ ...prev, controlHotWork_rating: value }))}
                    />
                    <input
                      type="text"
                      id="controlHotWork"
                      name="controlHotWork"
                      value={formData.controlHotWork}
                      onChange={handleInputChange}
                      className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all mt-2"
                      placeholder="Describe control of hot work"
                    />
                  </div>

                  <div>
                    <label htmlFor="electricalMaintenance" className="block text-sm font-medium text-slate-700 mb-2">
                      Electrical maintenance
                    </label>
                    <RatingRadio
                      value={formData.electricalMaintenance_rating}
                      onChange={(value) => setFormData(prev => ({ ...prev, electricalMaintenance_rating: value }))}
                    />
                    <input
                      type="text"
                      id="electricalMaintenance"
                      name="electricalMaintenance"
                      value={formData.electricalMaintenance}
                      onChange={handleInputChange}
                      className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all mt-2"
                      placeholder="Describe electrical maintenance"
                    />
                  </div>

                  <div>
                    <label htmlFor="generalMaintenance" className="block text-sm font-medium text-slate-700 mb-2">
                      General maintenance
                    </label>
                    <RatingRadio
                      value={formData.generalMaintenance_rating}
                      onChange={(value) => setFormData(prev => ({ ...prev, generalMaintenance_rating: value }))}
                    />
                    <input
                      type="text"
                      id="generalMaintenance"
                      name="generalMaintenance"
                      value={formData.generalMaintenance}
                      onChange={handleInputChange}
                      className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all mt-2"
                      placeholder="Describe general maintenance"
                    />
                  </div>

                  <div>
                    <label htmlFor="smokingControls" className="block text-sm font-medium text-slate-700 mb-2">
                      Smoking controls
                    </label>
                    <RatingRadio
                      value={formData.smokingControls_rating}
                      onChange={(value) => setFormData(prev => ({ ...prev, smokingControls_rating: value }))}
                    />
                    <input
                      type="text"
                      id="smokingControls"
                      name="smokingControls"
                      value={formData.smokingControls}
                      onChange={handleInputChange}
                      className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all mt-2"
                      placeholder="Describe smoking controls"
                    />
                  </div>

                  <div>
                    <label htmlFor="fireSafetyHousekeeping" className="block text-sm font-medium text-slate-700 mb-2">
                      Housekeeping
                    </label>
                    <RatingRadio
                      value={formData.fireSafetyHousekeeping_rating}
                      onChange={(value) => setFormData(prev => ({ ...prev, fireSafetyHousekeeping_rating: value }))}
                    />
                    <textarea
                      id="fireSafetyHousekeeping"
                      name="fireSafetyHousekeeping"
                      value={formData.fireSafetyHousekeeping}
                      onChange={handleInputChange}
                      rows={4}
                      className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all resize-none mt-2"
                      placeholder="Describe fire safety and housekeeping practices"
                    />
                  </div>
                </div>
              </div>

              <div className="space-y-6">
                <h3 className="text-lg font-semibold text-slate-900 pb-2 border-b border-slate-300">
                  Emergency Response
                </h3>

                <div className="space-y-4">
                  <div>
                    <label htmlFor="selfInspections" className="block text-sm font-medium text-slate-700 mb-2">
                      Self-inspections
                    </label>
                    <RatingRadio
                      value={formData.selfInspections_rating}
                      onChange={(value) => setFormData(prev => ({ ...prev, selfInspections_rating: value }))}
                    />
                    <input
                      type="text"
                      id="selfInspections"
                      name="selfInspections"
                      value={formData.selfInspections}
                      onChange={handleInputChange}
                      className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all mt-2"
                      placeholder="Describe self-inspections"
                    />
                  </div>

                  <div>
                    <label htmlFor="changeManagement" className="block text-sm font-medium text-slate-700 mb-2">
                      Change management
                    </label>
                    <RatingRadio
                      value={formData.changeManagement_rating}
                      onChange={(value) => setFormData(prev => ({ ...prev, changeManagement_rating: value }))}
                    />
                    <input
                      type="text"
                      id="changeManagement"
                      name="changeManagement"
                      value={formData.changeManagement}
                      onChange={handleInputChange}
                      className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all mt-2"
                      placeholder="Describe change management"
                    />
                  </div>

                  <div>
                    <label htmlFor="contractorControls" className="block text-sm font-medium text-slate-700 mb-2">
                      Contractor controls
                    </label>
                    <RatingRadio
                      value={formData.contractorControls_rating}
                      onChange={(value) => setFormData(prev => ({ ...prev, contractorControls_rating: value }))}
                    />
                    <input
                      type="text"
                      id="contractorControls"
                      name="contractorControls"
                      value={formData.contractorControls}
                      onChange={handleInputChange}
                      className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all mt-2"
                      placeholder="Describe contractor controls"
                    />
                  </div>

                  <div>
                    <label htmlFor="impairmentHandling" className="block text-sm font-medium text-slate-700 mb-2">
                      Impairment handling
                    </label>
                    <RatingRadio
                      value={formData.impairmentHandling_rating}
                      onChange={(value) => setFormData(prev => ({ ...prev, impairmentHandling_rating: value }))}
                    />
                    <input
                      type="text"
                      id="impairmentHandling"
                      name="impairmentHandling"
                      value={formData.impairmentHandling}
                      onChange={handleInputChange}
                      className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all mt-2"
                      placeholder="Describe impairment handling"
                    />
                  </div>

                  <div>
                    <label htmlFor="emergencyResponse" className="block text-sm font-medium text-slate-700 mb-2">
                      Emergency Response
                    </label>
                    <RatingRadio
                      value={formData.emergencyResponse_rating}
                      onChange={(value) => setFormData(prev => ({ ...prev, emergencyResponse_rating: value }))}
                    />
                    <textarea
                      id="emergencyResponse"
                      name="emergencyResponse"
                      value={formData.emergencyResponse}
                      onChange={handleInputChange}
                      rows={4}
                      className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all resize-none mt-2"
                      placeholder="Describe emergency response procedures"
                    />
                  </div>
                </div>
              </div>

              <SectionGrade
                sectionKey="management"
                sectionTitle="Management Systems"
                value={formData.sectionGrades.management || 3}
                onChange={(value) => handleSectionGradeChange('management', value)}
                disabled={isIssued}
              />
            </div>
          </div>

          {surveyType === 'Full' && (
            <>
              <div className="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
                <h2 className="text-2xl font-semibold text-slate-900 mb-6 pb-3 border-b border-slate-200">
                  Section 6: Fire Protection / Detection
                </h2>

            <div className="overflow-x-auto mb-8">
              <table className="w-full text-sm border-collapse">
                <thead>
                  <tr className="bg-slate-100 border-b-2 border-slate-300">
                    <th className="text-left py-3 px-3 font-semibold text-slate-700 border-r border-slate-300">Building Name</th>
                    <th className="text-center py-3 px-3 font-semibold text-slate-700 border-r border-slate-300">Fire Protection<br />Coverage (%)</th>
                    <th className="text-center py-3 px-3 font-semibold text-slate-700 border-r border-slate-300">Required<br />(%)</th>
                    <th className="text-center py-3 px-3 font-semibold text-slate-700 border-r border-slate-300">Recommended<br />(%)</th>
                    <th className="text-center py-3 px-3 font-semibold text-slate-700 border-r border-slate-300">Adequacy</th>
                    <th className="text-center py-3 px-3 font-semibold text-slate-700 border-r border-slate-300">Fire Detection<br />Coverage (%)</th>
                    <th className="text-center py-3 px-3 font-semibold text-slate-700">Water Supply<br />Rating</th>
                  </tr>
                </thead>
                <tbody>
                  {formData.buildings.map((building, buildingIndex) => (
                    <tr key={building.id} className="border-b border-slate-200 hover:bg-slate-50">
                      <td className="py-3 px-3 font-medium text-slate-900 border-r border-slate-200">
                        {building.building_name || `Building ${buildingIndex + 1}`}
                      </td>
                      <td className="py-3 px-3 text-center text-slate-600 border-r border-slate-200">
                        {building.fire_protection.sprinkler_coverage_pct}%
                      </td>
                      <td className="py-3 px-3 border-r border-slate-200">
                        {(() => {
                          const coverage = parseFloat(building.fire_protection.sprinkler_coverage_pct) || 0;
                          const required = parseFloat(building.fire_protection_summary.required_pct) || 0;
                          const maxRequired = 100 - coverage;
                          const isExceeded = required + coverage > 100;

                          return (
                            <div className="flex flex-col items-center">
                              <input
                                type="text"
                                value={building.fire_protection_summary.required_pct}
                                onChange={(e) => {
                                  const newBuildings = [...formData.buildings];
                                  newBuildings[buildingIndex].fire_protection_summary.required_pct = e.target.value;
                                  setFormData(prev => ({ ...prev, buildings: newBuildings }));
                                }}
                                className={`w-16 px-2 py-1 border rounded text-center focus:ring-2 focus:border-transparent transition-all ${
                                  isExceeded
                                    ? 'border-amber-400 focus:ring-amber-500'
                                    : 'border-slate-300 focus:ring-slate-500'
                                }`}
                                placeholder="0"
                                title={`Required % cannot exceed 100% when added to actual coverage %. Maximum allowed: ${maxRequired}%`}
                              />
                              <div className="text-xs text-slate-500 mt-1">Max: {maxRequired}%</div>
                              {isExceeded && (
                                <div className="text-xs text-amber-600 font-medium mt-1 whitespace-nowrap">
                                   Too high
                                </div>
                              )}
                            </div>
                          );
                        })()}
                      </td>
                      <td className="py-3 px-3 border-r border-slate-200">
                        {(() => {
                          const coverage = parseFloat(building.fire_protection.sprinkler_coverage_pct) || 0;
                          const recommended = parseFloat(building.fire_protection_summary.recommended_pct) || 0;
                          const maxRecommended = 100 - coverage;
                          const isExceeded = recommended + coverage > 100;

                          return (
                            <div className="flex flex-col items-center">
                              <input
                                type="text"
                                value={building.fire_protection_summary.recommended_pct}
                                onChange={(e) => {
                                  const newBuildings = [...formData.buildings];
                                  newBuildings[buildingIndex].fire_protection_summary.recommended_pct = e.target.value;
                                  setFormData(prev => ({ ...prev, buildings: newBuildings }));
                                }}
                                className={`w-16 px-2 py-1 border rounded text-center focus:ring-2 focus:border-transparent transition-all ${
                                  isExceeded
                                    ? 'border-amber-400 focus:ring-amber-500'
                                    : 'border-slate-300 focus:ring-slate-500'
                                }`}
                                placeholder="0"
                                title={`Recommended % cannot exceed 100% when added to actual coverage %. Maximum allowed: ${maxRecommended}%`}
                              />
                              <div className="text-xs text-slate-500 mt-1">Max: {maxRecommended}%</div>
                              {isExceeded && (
                                <div className="text-xs text-amber-600 font-medium mt-1 whitespace-nowrap">
                                   Too high
                                </div>
                              )}
                            </div>
                          );
                        })()}
                      </td>
                      <td className="py-3 px-3 border-r border-slate-200">
                        <div className="flex flex-col gap-1">
                          {['Adequate', 'Tolerable', 'Inadequate'].map((rating) => (
                            <label
                              key={rating}
                              className={`flex items-center gap-1 cursor-pointer px-2 py-1 rounded border transition-all ${
                                building.fire_protection_summary.adequacy_rating === rating
                                  ? rating === 'Adequate' ? 'bg-green-100 border-green-500' :
                                    rating === 'Tolerable' ? 'bg-amber-100 border-amber-500' :
                                    'bg-red-100 border-red-500'
                                  : 'border-slate-200 hover:border-slate-300'
                              }`}
                            >
                              <input
                                type="radio"
                                name={`adequacy-${building.id}`}
                                value={rating}
                                checked={building.fire_protection_summary.adequacy_rating === rating}
                                onChange={(e) => {
                                  const newBuildings = [...formData.buildings];
                                  newBuildings[buildingIndex].fire_protection_summary.adequacy_rating = e.target.value;
                                  setFormData(prev => ({ ...prev, buildings: newBuildings }));
                                }}
                                className="sr-only"
                              />
                              <div
                                className={`w-2 h-2 rounded-full flex-shrink-0 ${
                                  rating === 'Adequate' ? 'bg-green-500' :
                                  rating === 'Tolerable' ? 'bg-amber-500' :
                                  'bg-red-500'
                                }`}
                              />
                              <span className="text-xs whitespace-nowrap">{rating}</span>
                            </label>
                          ))}
                        </div>
                      </td>
                      <td className="py-3 px-3 text-center text-slate-600 border-r border-slate-200">
                        {building.fire_protection.detection_coverage_pct}%
                      </td>
                      <td className="py-3 px-3 text-center">
                        <div className="flex flex-col gap-1 items-center">
                          {['Reliable', 'Unreliable'].map((rating) => (
                            <label
                              key={rating}
                              className={`flex items-center gap-1 cursor-pointer px-2 py-1 rounded border transition-all ${
                                building.water_supply_rating === rating
                                  ? rating === 'Reliable' ? 'bg-green-100 border-green-500' : 'bg-red-100 border-red-500'
                                  : 'border-slate-200 hover:border-slate-300'
                              }`}
                            >
                              <input
                                type="radio"
                                name={`water-supply-${building.id}`}
                                value={rating}
                                checked={building.water_supply_rating === rating}
                                onChange={(e) => {
                                  const newBuildings = [...formData.buildings];
                                  newBuildings[buildingIndex].water_supply_rating = e.target.value;
                                  setFormData(prev => ({ ...prev, buildings: newBuildings }));
                                }}
                                className="sr-only"
                              />
                              <div
                                className={`w-2 h-2 rounded-full flex-shrink-0 ${
                                  rating === 'Reliable' ? 'bg-green-500' : 'bg-red-500'
                                }`}
                              />
                              <span className="text-xs whitespace-nowrap">{rating}</span>
                            </label>
                          ))}
                        </div>
                      </td>
                    </tr>
                  ))}
                  <tr className="bg-slate-100 border-t-2 border-slate-300 font-semibold">
                    <td className="py-3 px-3 text-slate-900 border-r border-slate-200">
                      Total
                    </td>
                    <td className="py-3 px-3 text-center text-slate-900 border-r border-slate-200">
                      {(() => {
                        const total = formData.buildings.reduce((sum, b) => sum + (parseFloat(b.fire_protection.sprinkler_coverage_pct) || 0), 0);
                        const avg = formData.buildings.length > 0 ? (total / formData.buildings.length).toFixed(1) : '0';
                        return `${avg}%`;
                      })()}
                    </td>
                    <td className="py-3 px-3 text-center text-slate-900 border-r border-slate-200">
                      {(() => {
                        const total = formData.buildings.reduce((sum, b) => sum + (parseFloat(b.fire_protection_summary.required_pct) || 0), 0);
                        const avg = formData.buildings.length > 0 ? (total / formData.buildings.length).toFixed(1) : '0';
                        return `${avg}%`;
                      })()}
                    </td>
                    <td className="py-3 px-3 text-center text-slate-900 border-r border-slate-200">
                      {(() => {
                        const total = formData.buildings.reduce((sum, b) => sum + (parseFloat(b.fire_protection_summary.recommended_pct) || 0), 0);
                        const avg = formData.buildings.length > 0 ? (total / formData.buildings.length).toFixed(1) : '0';
                        return `${avg}%`;
                      })()}
                    </td>
                    <td className="py-3 px-3 border-r border-slate-200"></td>
                    <td className="py-3 px-3 text-center text-slate-900 border-r border-slate-200">
                      {(() => {
                        const total = formData.buildings.reduce((sum, b) => sum + (parseFloat(b.fire_protection.detection_coverage_pct) || 0), 0);
                        const avg = formData.buildings.length > 0 ? (total / formData.buildings.length).toFixed(1) : '0';
                        return `${avg}%`;
                      })()}
                    </td>
                    <td className="py-3 px-3"></td>
                  </tr>
                </tbody>
              </table>
            </div>

            <div className="space-y-6">
              <div className="border-t-2 border-slate-200 pt-6">
                <h3 className="text-lg font-semibold text-slate-900 mb-4">Fire Protection Notes</h3>
                <textarea
                  value={formData.fireProtectionNotes}
                  onChange={(e) => setFormData(prev => ({ ...prev, fireProtectionNotes: e.target.value }))}
                  rows={4}
                  className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all resize-none"
                  placeholder="Provide general observations and notes on fire protection systems across all buildings"
                />
              </div>

              <div className="border-t-2 border-slate-200 pt-6">
                <h3 className="text-lg font-semibold text-slate-900 mb-4">Fire Detection Notes</h3>
                <RatingRadio
                  value={formData.fireDetectionNotes_rating}
                  onChange={(value) => setFormData(prev => ({ ...prev, fireDetectionNotes_rating: value }))}
                />
                <textarea
                  value={formData.fireDetectionNotes}
                  onChange={(e) => setFormData(prev => ({ ...prev, fireDetectionNotes: e.target.value }))}
                  rows={4}
                  className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all resize-none mt-2"
                  placeholder="Describe fire detection systems and observations across all buildings"
                />
              </div>

              <div className="border-t-2 border-slate-200 pt-6">
                <h3 className="text-lg font-semibold text-slate-900 mb-4">Fire Hydrant Notes</h3>
                <RatingRadio
                  value={formData.fireHydrantNotes_rating}
                  onChange={(value) => setFormData(prev => ({ ...prev, fireHydrantNotes_rating: value }))}
                />
                <textarea
                  value={formData.fireHydrantNotes}
                  onChange={(e) => setFormData(prev => ({ ...prev, fireHydrantNotes: e.target.value }))}
                  rows={4}
                  className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all resize-none mt-2"
                  placeholder="Describe hydrant conditions and accessibility across all buildings"
                />
              </div>

              <div className="border-t-2 border-slate-200 pt-6">
                <h3 className="text-lg font-semibold text-slate-900 mb-4">Water Supply Notes</h3>
                <div className="mb-2">
                  <label className="block text-sm font-medium text-slate-700 mb-2">Overall Rating</label>
                  <div className="flex gap-4">
                    {['Reliable', 'Unreliable'].map((rating) => (
                      <label
                        key={rating}
                        className={`flex items-center gap-2 cursor-pointer px-4 py-2 rounded-lg border-2 transition-all ${
                          formData.waterSupplyNotes_rating === rating
                            ? rating === 'Reliable'
                              ? 'bg-green-50 border-green-500 text-green-700'
                              : 'bg-red-50 border-red-500 text-red-700'
                            : 'border-slate-300 hover:border-slate-400 text-slate-700'
                        }`}
                      >
                        <input
                          type="radio"
                          name="waterSupplyRating"
                          value={rating}
                          checked={formData.waterSupplyNotes_rating === rating}
                          onChange={(e) => setFormData(prev => ({ ...prev, waterSupplyNotes_rating: e.target.value }))}
                          className="sr-only"
                        />
                        <div
                          className={`w-3 h-3 rounded-full flex-shrink-0 ${
                            rating === 'Reliable' ? 'bg-green-500' : 'bg-red-500'
                          }`}
                        />
                        <span className="font-medium">{rating}</span>
                      </label>
                    ))}
                  </div>
                </div>
                <textarea
                  value={formData.waterSupplyNotes}
                  onChange={(e) => setFormData(prev => ({ ...prev, waterSupplyNotes: e.target.value }))}
                  rows={4}
                  className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all resize-none"
                  placeholder="Describe water supply and pressure across all buildings"
                />
              </div>

              <SectionGrade
                sectionKey="fire_protection"
                sectionTitle="Fire Protection / Detection"
                value={formData.sectionGrades.fire_protection || 3}
                onChange={(value) => handleSectionGradeChange('fire_protection', value)}
                disabled={isIssued}
              />
            </div>
          </div>

          <div className="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
            <h2 className="text-2xl font-semibold text-slate-900 mb-6 pb-3 border-b border-slate-200">
              Section 7: Special Hazards
            </h2>
            <p className="text-sm text-slate-600 mb-6">
              Include specific areas, equipment, or materials (like ignitable liquids, combustible dusts, aerosols, high-hazard chemicals, or flammable gases) that can quickly overwhelm standard fire protection, potentially leading to catastrophic losses.
            </p>

            <div className="space-y-4">
              {specialHazards.map((hazard, hazardIndex) => (
                <div key={hazard.id} className="relative p-4 border border-slate-300 rounded-lg bg-white">
                  <div className="flex items-start justify-between gap-4 mb-4">
                    <div className="flex-1">
                      <label className="block text-sm font-medium text-slate-700 mb-2">
                        Hazard Title
                      </label>
                      <input
                        type="text"
                        value={hazard.title}
                        onChange={(e) => {
                          const newHazards = [...specialHazards];
                          newHazards[hazardIndex].title = e.target.value;
                          setSpecialHazards(newHazards);
                        }}
                        className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all"
                        placeholder="Enter specific hazard (e.g., ignitable liquids, combustible dusts, aerosols)"
                      />
                    </div>
                    <button
                      type="button"
                      onClick={() => {
                        setSpecialHazards(specialHazards.filter((_, i) => i !== hazardIndex));
                      }}
                      className="mt-7 text-red-600 hover:text-red-700 hover:bg-red-50 p-2 rounded-lg transition-all"
                      title="Remove hazard"
                    >
                      <Trash2 className="w-5 h-5" />
                    </button>
                  </div>

                  <div className="mb-4">
                    <label className="block text-sm font-medium text-slate-700 mb-2">
                      Description of Hazard / Deficiency
                    </label>
                    <textarea
                      value={hazard.description}
                      onChange={(e) => {
                        const newHazards = [...specialHazards];
                        newHazards[hazardIndex].description = e.target.value;
                        setSpecialHazards(newHazards);
                      }}
                      rows={3}
                      className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all resize-none"
                      placeholder="Provide details on location, storage, processes, etc."
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-medium text-slate-700 mb-2">
                      Hazard Rating
                    </label>
                    <div className="flex gap-3">
                      {[
                        { value: 'Good', label: 'Good ', color: 'green' },
                        { value: 'Tolerable', label: 'Tolerable ', color: 'amber' },
                        { value: 'Poor', label: 'Poor ', color: 'red' }
                      ].map((option) => (
                        <label
                          key={option.value}
                          className={`flex items-center gap-2 cursor-pointer px-4 py-2 rounded-lg border-2 transition-all flex-1 ${
                            hazard.rating === option.value
                              ? option.color === 'green'
                                ? 'bg-green-50 border-green-500 text-green-700'
                                : option.color === 'amber'
                                ? 'bg-amber-50 border-amber-500 text-amber-700'
                                : 'bg-red-50 border-red-500 text-red-700'
                              : 'border-slate-300 hover:border-slate-400 text-slate-700'
                          }`}
                        >
                          <input
                            type="radio"
                            name={`special-hazard-rating-${hazard.id}`}
                            value={option.value}
                            checked={hazard.rating === option.value}
                            onChange={(e) => {
                              const newHazards = [...specialHazards];
                              newHazards[hazardIndex].rating = e.target.value;
                              setSpecialHazards(newHazards);
                            }}
                            className="sr-only"
                          />
                          <span className="text-sm font-medium">{option.label}</span>
                        </label>
                      ))}
                    </div>
                    <p className="text-xs text-slate-500 mt-2">
                      Good = Low concern; Tolerable = Minor concern; Poor = High risk
                    </p>
                  </div>
                </div>
              ))}

              <button
                type="button"
                onClick={() => {
                  setSpecialHazards([...specialHazards, {
                    id: crypto.randomUUID(),
                    title: '',
                    description: '',
                    rating: ''
                  }]);
                }}
                className="w-full flex items-center justify-center gap-2 py-3 px-4 border-2 border-dashed border-slate-300 rounded-lg text-slate-600 hover:border-slate-400 hover:text-slate-700 hover:bg-white transition-all font-medium"
              >
                <Plus className="w-5 h-5" />
                Add Hazard
              </button>

              <SectionGrade
                sectionKey="hazards"
                sectionTitle="Special Hazards"
                value={formData.sectionGrades.hazards || 3}
                onChange={(value) => handleSectionGradeChange('hazards', value)}
                disabled={isIssued}
              />
            </div>
          </div>

          <div className="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
            <h2 className="text-2xl font-semibold text-slate-900 mb-6 pb-3 border-b border-slate-200">
              Section 8: Business Continuity
            </h2>
            <div className="space-y-4">
              <div>
                <label htmlFor="businessInterruption" className="block text-sm font-medium text-slate-700 mb-2">
                  Business Interruption
                </label>
                <textarea
                  id="businessInterruption"
                  name="businessInterruption"
                  value={formData.businessInterruption}
                  onChange={handleInputChange}
                  rows={4}
                  className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all resize-none"
                  placeholder="Describe business interruption considerations"
                />
              </div>

              <div>
                <label htmlFor="interdependencies" className="block text-sm font-medium text-slate-700 mb-2">
                  Interdependencies
                </label>
                <textarea
                  id="interdependencies"
                  name="interdependencies"
                  value={formData.interdependencies}
                  onChange={handleInputChange}
                  rows={4}
                  className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all resize-none"
                  placeholder="Describe interdependencies"
                />
              </div>

              <div>
                <label htmlFor="bcp" className="block text-sm font-medium text-slate-700 mb-2">
                  Business Continuity Plan (BCP) Review
                </label>
                <textarea
                  id="bcp"
                  name="bcp"
                  value={formData.bcp}
                  onChange={handleInputChange}
                  rows={4}
                  className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all resize-none"
                  placeholder="Describe business continuity plan"
                />
                <div className="mt-4">
                  <RatingRadio
                    label="BCP Review rating"
                    name="bcp_rating"
                    value={formData.bcp_rating}
                    onChange={handleInputChange}
                    options={['Good', 'Tolerable', 'Poor']}
                  />
                </div>
              </div>

              <SectionGrade
                sectionKey="business_continuity"
                sectionTitle="Business Continuity"
                value={formData.sectionGrades.business_continuity || 3}
                onChange={(value) => handleSectionGradeChange('business_continuity', value)}
                disabled={isIssued}
              />
            </div>
          </div>

          <div className="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
            <h2 className="text-2xl font-semibold text-slate-900 mb-6 pb-3 border-b border-slate-200">
              Section 9: Loss Expectancy
            </h2>

            <div className="space-y-8">
              <div>
                <h3 className="text-xl font-semibold text-slate-900 mb-4">Table 1: Sums Insured</h3>
                <div className="overflow-x-auto">
                  <table className="w-full border-collapse">
                    <thead>
                      <tr className="bg-slate-100">
                        <th className="border border-slate-300 px-4 py-2 text-left text-sm font-semibold text-slate-700">Property Damage</th>
                        <th className="border border-slate-300 px-4 py-2 text-left text-sm font-semibold text-slate-700">Value</th>
                      </tr>
                    </thead>
                    <tbody>
                      {sumsInsured.map((row) => (
                        <tr key={row.id}>
                          <td className="border border-slate-300 px-4 py-2 text-sm">
                            {row.item === 'Other' ? (
                              <input
                                type="text"
                                value={row.item}
                                onChange={(e) => updateSumsInsured(row.id, 'item', e.target.value)}
                                className="w-full px-2 py-1 border border-slate-300 rounded focus:ring-2 focus:ring-slate-500 focus:border-transparent"
                                placeholder="Other item name"
                              />
                            ) : (
                              row.item
                            )}
                          </td>
                          <td className="border border-slate-300 px-4 py-2">
                            <input
                              type="number"
                              value={row.pd_value}
                              onChange={(e) => updateSumsInsured(row.id, 'pd_value', e.target.value)}
                              className="w-full px-2 py-1 border border-slate-300 rounded focus:ring-2 focus:ring-slate-500 focus:border-transparent text-sm"
                              placeholder="0"
                            />
                          </td>
                        </tr>
                      ))}
                      <tr className="bg-slate-100 font-semibold">
                        <td className="border border-slate-300 px-4 py-2 text-sm">Total Property</td>
                        <td className="border border-slate-300 px-4 py-2 text-sm">
                          {sumsInsured.reduce((sum, row) => sum + (parseFloat(row.pd_value) || 0), 0).toLocaleString()}
                        </td>
                      </tr>
                    </tbody>
                  </table>

                  <table className="w-full border-collapse mt-6">
                    <thead>
                      <tr className="bg-slate-100">
                        <th className="border border-slate-300 px-4 py-2 text-left text-sm font-semibold text-slate-700">Business Interruption</th>
                        <th className="border border-slate-300 px-4 py-2 text-left text-sm font-semibold text-slate-700">Value</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td className="border border-slate-300 px-4 py-2 text-sm">Gross Profit</td>
                        <td className="border border-slate-300 px-4 py-2">
                          <input
                            type="number"
                            value={businessInterruptionValue}
                            onChange={(e) => setBusinessInterruptionValue(e.target.value)}
                            className="w-full px-2 py-1 border border-slate-300 rounded focus:ring-2 focus:ring-slate-500 focus:border-transparent text-sm"
                            placeholder="0"
                          />
                        </td>
                      </tr>
                      <tr className="bg-slate-100 font-semibold">
                        <td className="border border-slate-300 px-4 py-2 text-sm">Total BI</td>
                        <td className="border border-slate-300 px-4 py-2 text-sm">
                          {parseFloat(businessInterruptionValue || '0').toLocaleString()}
                        </td>
                      </tr>
                    </tbody>
                  </table>

                  <div className="grid grid-cols-2 gap-4 mt-6">
                    <div>
                      <label htmlFor="indemnityPeriod" className="block text-sm font-medium text-slate-700 mb-2">
                        Indemnity Period (months)
                      </label>
                      <input
                        type="number"
                        id="indemnityPeriod"
                        value={indemnityPeriod}
                        onChange={(e) => setIndemnityPeriod(e.target.value)}
                        className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent text-sm"
                        placeholder="e.g., 18"
                      />
                    </div>
                    <div>
                      <label htmlFor="currency" className="block text-sm font-medium text-slate-700 mb-2">
                        Currency
                      </label>
                      <select
                        id="currency"
                        value={selectedCurrency}
                        onChange={(e) => setSelectedCurrency(e.target.value)}
                        className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent text-sm bg-white"
                      >
                        <option value="GBP">GBP ()</option>
                        <option value="USD">USD ($)</option>
                        <option value="EUR">EUR ()</option>
                        <option value="JPY">JPY ()</option>
                        <option value="CNY">CNY ()</option>
                        <option value="INR">INR ()</option>
                        <option value="AUD">AUD ($)</option>
                        <option value="CAD">CAD ($)</option>
                        <option value="CHF">CHF (Fr)</option>
                        <option value="SGD">SGD ($)</option>
                        <option value="HKD">HKD ($)</option>
                        <option value="AED">AED (.)</option>
                      </select>
                    </div>
                  </div>
                </div>
              </div>

              <div>
                <label htmlFor="lossExpectancyComments" className="block text-sm font-medium text-slate-700 mb-2">
                  Additional Comments
                </label>
                <textarea
                  id="lossExpectancyComments"
                  value={lossExpectancyComments}
                  onChange={(e) => setLossExpectancyComments(e.target.value)}
                  rows={4}
                  className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all resize-y"
                  placeholder="Enter additional comments about sums insured"
                />
              </div>

              <div>
                <h3 className="text-xl font-semibold text-slate-900 mb-2">Table 2: Worst Case Loss Expectancy (WCL)</h3>
                <p className="text-sm text-slate-600 mb-4">
                  An estimation of the maximum loss potential derived from the property and business interruption coverage that could be sustained assuming failure of installed fire protection and ineffective emergency response.
                </p>

                <div className="space-y-6">
                  <div>
                    <h4 className="text-lg font-medium text-slate-900 mb-3">Property Damage</h4>
                    <div className="overflow-x-auto">
                      <table className="w-full border-collapse">
                        <thead>
                          <tr className="bg-slate-100">
                            <th className="border border-slate-300 px-4 py-2 text-left text-sm font-semibold text-slate-700">Item</th>
                            <th className="border border-slate-300 px-4 py-2 text-left text-sm font-semibold text-slate-700">% of Value</th>
                            <th className="border border-slate-300 px-4 py-2 text-left text-sm font-semibold text-slate-700">Sub-total ()</th>
                          </tr>
                        </thead>
                        <tbody>
                          {worstCasePD.map((row) => (
                            <tr key={row.id}>
                              <td className="border border-slate-300 px-4 py-2 text-sm">{row.item}</td>
                              <td className="border border-slate-300 px-4 py-2">
                                <input
                                  type="number"
                                  value={row.percent}
                                  onChange={(e) => updateWorstCasePD(row.id, 'percent', e.target.value)}
                                  className="w-full px-2 py-1 border border-slate-300 rounded focus:ring-2 focus:ring-slate-500 focus:border-transparent text-sm"
                                  placeholder="0"
                                  min="0"
                                  max="100"
                                />
                              </td>
                              <td className="border border-slate-300 px-4 py-2 text-sm bg-slate-50 font-medium">
                                {row.subtotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                              </td>
                            </tr>
                          ))}
                          <tr className="bg-slate-100 font-semibold">
                            <td className="border border-slate-300 px-4 py-2 text-sm">Worst Case LE: PD Total</td>
                            <td className="border border-slate-300 px-4 py-2 text-sm">
                              {worstCasePD.length > 0 ?
                                `${((calculateWorstCaseTotals().pdTotal / sumsInsured.reduce((sum, row) => sum + (parseFloat(row.pd_value) || 0), 0)) * 100).toFixed(1)}%`
                                : '0%'}
                            </td>
                            <td className="border border-slate-300 px-4 py-2 text-sm">
                              {calculateWorstCaseTotals().pdTotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <div>
                    <h4 className="text-lg font-medium text-slate-900 mb-3">Business Interruption</h4>

                    {getTotalMonths() > parseFloat(indemnityPeriod || '0') && indemnityPeriod && (
                      <div className="mb-4 p-3 bg-amber-50 border border-amber-300 rounded-lg flex items-start">
                        <AlertCircle className="w-5 h-5 text-amber-600 mr-2 flex-shrink-0 mt-0.5" />
                        <div className="text-sm text-amber-800">
                          <strong>Warning:</strong> Total months ({getTotalMonths()}) exceeds the indemnity period ({indemnityPeriod} months)
                        </div>
                      </div>
                    )}

                    <div className="overflow-x-auto">
                      <table className="w-full border-collapse">
                        <thead>
                          <tr className="bg-slate-100">
                            <th className="border border-slate-300 px-4 py-2 text-left text-sm font-semibold text-slate-700">Item</th>
                            <th className="border border-slate-300 px-4 py-2 text-left text-sm font-semibold text-slate-700">Months</th>
                            <th className="border border-slate-300 px-4 py-2 text-left text-sm font-semibold text-slate-700">% of GP / Value</th>
                            <th className="border border-slate-300 px-4 py-2 text-left text-sm font-semibold text-slate-700">Sub-totals ()</th>
                          </tr>
                        </thead>
                        <tbody>
                          {worstCaseBI.map((row, index) => (
                            <tr key={row.id}>
                              <td className="border border-slate-300 px-4 py-2 text-sm">
                                {index < 2 ? (
                                  row.item
                                ) : (
                                  <input
                                    type="text"
                                    value={row.item}
                                    onChange={(e) => updateWorstCaseBI(row.id, 'item', e.target.value)}
                                    className="w-full px-2 py-1 border border-slate-300 rounded focus:ring-2 focus:ring-slate-500 focus:border-transparent text-sm"
                                    placeholder="Phase name"
                                  />
                                )}
                              </td>
                              <td className="border border-slate-300 px-4 py-2">
                                <input
                                  type="number"
                                  value={row.months}
                                  onChange={(e) => updateWorstCaseBI(row.id, 'months', e.target.value)}
                                  className="w-full px-2 py-1 border border-slate-300 rounded focus:ring-2 focus:ring-slate-500 focus:border-transparent text-sm"
                                  placeholder="0"
                                />
                              </td>
                              <td className="border border-slate-300 px-4 py-2">
                                <input
                                  type="number"
                                  value={row.percent}
                                  onChange={(e) => updateWorstCaseBI(row.id, 'percent', e.target.value)}
                                  className="w-full px-2 py-1 border border-slate-300 rounded focus:ring-2 focus:ring-slate-500 focus:border-transparent text-sm"
                                  placeholder="0"
                                  min="0"
                                  max="100"
                                />
                              </td>
                              <td className="border border-slate-300 px-4 py-2 text-sm bg-slate-50 font-medium">
                                {row.subtotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                              </td>
                            </tr>
                          ))}
                          <tr className="bg-slate-100 font-semibold">
                            <td className="border border-slate-300 px-4 py-2 text-sm" colSpan={3}>Worst Case LE: BI Total</td>
                            <td className="border border-slate-300 px-4 py-2 text-sm">
                              {calculateWorstCaseTotals().biTotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                            </td>
                          </tr>
                          <tr className="bg-slate-200 font-bold">
                            <td className="border border-slate-300 px-4 py-2 text-sm" colSpan={3}>Worst Case LE: PD + BI Total</td>
                            <td className="border border-slate-300 px-4 py-2 text-sm">
                              {calculateWorstCaseTotals().combinedTotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                            </td>
                          </tr>
                        </tbody>
                      </table>
                      <button
                        type="button"
                        onClick={addWorstCaseBIRow}
                        className="mt-3 flex items-center px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors"
                      >
                        <Plus className="w-4 h-4 mr-2" />
                        Add Recovery Phase
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <div>
                <label htmlFor="wclScenarioDescription" className="block text-sm font-medium text-slate-700 mb-2">
                  WCL Scenario Description
                </label>
                <textarea
                  id="wclScenarioDescription"
                  name="wclScenarioDescription"
                  value={formData.wclScenarioDescription}
                  onChange={handleInputChange}
                  rows={4}
                  className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all resize-y"
                  placeholder="Enter WCL scenario description"
                />
              </div>

              <div>
                <h3 className="text-xl font-semibold text-slate-900 mb-2">Table 3: NLE All RIs Completed Loss Estimate</h3>
                <p className="text-sm text-slate-600 mb-4">
                  An estimation of the maximum loss potential that can be expected with all risk improvements completed, giving credit to fire protection and detection systems (where considered reliable), effective on-site emergency response and emergency service intervention.
                </p>

                <div className="space-y-6">
                  <div>
                    <h4 className="text-lg font-medium text-slate-900 mb-3">Property Damage</h4>
                    <div className="overflow-x-auto">
                      <table className="w-full border-collapse">
                        <thead>
                          <tr className="bg-slate-100">
                            <th className="border border-slate-300 px-4 py-2 text-left text-sm font-semibold text-slate-700">Item</th>
                            <th className="border border-slate-300 px-4 py-2 text-left text-sm font-semibold text-slate-700">% of Value</th>
                            <th className="border border-slate-300 px-4 py-2 text-left text-sm font-semibold text-slate-700">Sub-total ()</th>
                          </tr>
                        </thead>
                        <tbody>
                          {nleAllRIsPD.map((row) => (
                            <tr key={row.id}>
                              <td className="border border-slate-300 px-4 py-2 text-sm">{row.item}</td>
                              <td className="border border-slate-300 px-4 py-2">
                                <input
                                  type="number"
                                  value={row.percent}
                                  onChange={(e) => updateNleAllRIsPD(row.id, 'percent', e.target.value)}
                                  className="w-full px-2 py-1 border border-slate-300 rounded focus:ring-2 focus:ring-slate-500 focus:border-transparent text-sm"
                                  placeholder="0"
                                  min="0"
                                  max="100"
                                />
                              </td>
                              <td className="border border-slate-300 px-4 py-2 text-sm bg-slate-50 font-medium">
                                {row.subtotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                              </td>
                            </tr>
                          ))}
                          <tr className="bg-slate-100 font-semibold">
                            <td className="border border-slate-300 px-4 py-2 text-sm">NLE All RIs Completed: PD Total</td>
                            <td className="border border-slate-300 px-4 py-2 text-sm">
                              {nleAllRIsPD.length > 0 ?
                                `${((calculateNleAllRIsTotals().pdTotal / sumsInsured.reduce((sum, row) => sum + (parseFloat(row.pd_value) || 0), 0)) * 100).toFixed(1)}%`
                                : '0%'}
                            </td>
                            <td className="border border-slate-300 px-4 py-2 text-sm">
                              {calculateNleAllRIsTotals().pdTotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                            </td>
                          </tr>
                        </tbody>
                      </table>
                    </div>
                  </div>

                  <div>
                    <h4 className="text-lg font-medium text-slate-900 mb-3">Business Interruption</h4>

                    {getNleAllRIsTotalMonths() > parseFloat(indemnityPeriod || '0') && indemnityPeriod && (
                      <div className="mb-4 p-3 bg-amber-50 border border-amber-300 rounded-lg flex items-start">
                        <AlertCircle className="w-5 h-5 text-amber-600 mr-2 flex-shrink-0 mt-0.5" />
                        <div className="text-sm text-amber-800">
                          <strong>Warning:</strong> Total months ({getNleAllRIsTotalMonths()}) exceeds the indemnity period ({indemnityPeriod} months)
                        </div>
                      </div>
                    )}

                    <div className="overflow-x-auto">
                      <table className="w-full border-collapse">
                        <thead>
                          <tr className="bg-slate-100">
                            <th className="border border-slate-300 px-4 py-2 text-left text-sm font-semibold text-slate-700">Item</th>
                            <th className="border border-slate-300 px-4 py-2 text-left text-sm font-semibold text-slate-700">Months</th>
                            <th className="border border-slate-300 px-4 py-2 text-left text-sm font-semibold text-slate-700">% of GP / Value</th>
                            <th className="border border-slate-300 px-4 py-2 text-left text-sm font-semibold text-slate-700">Sub-totals ()</th>
                          </tr>
                        </thead>
                        <tbody>
                          {nleAllRIsBI.map((row, index) => (
                            <tr key={row.id}>
                              <td className="border border-slate-300 px-4 py-2 text-sm">
                                {index < 2 ? (
                                  row.item
                                ) : (
                                  <input
                                    type="text"
                                    value={row.item}
                                    onChange={(e) => updateNleAllRIsBI(row.id, 'item', e.target.value)}
                                    className="w-full px-2 py-1 border border-slate-300 rounded focus:ring-2 focus:ring-slate-500 focus:border-transparent text-sm"
                                    placeholder="Phase name"
                                  />
                                )}
                              </td>
                              <td className="border border-slate-300 px-4 py-2">
                                <input
                                  type="number"
                                  value={row.months}
                                  onChange={(e) => updateNleAllRIsBI(row.id, 'months', e.target.value)}
                                  className="w-full px-2 py-1 border border-slate-300 rounded focus:ring-2 focus:ring-slate-500 focus:border-transparent text-sm"
                                  placeholder="0"
                                />
                              </td>
                              <td className="border border-slate-300 px-4 py-2">
                                <input
                                  type="number"
                                  value={row.percent}
                                  onChange={(e) => updateNleAllRIsBI(row.id, 'percent', e.target.value)}
                                  className="w-full px-2 py-1 border border-slate-300 rounded focus:ring-2 focus:ring-slate-500 focus:border-transparent text-sm"
                                  placeholder="0"
                                  min="0"
                                  max="100"
                                />
                              </td>
                              <td className="border border-slate-300 px-4 py-2 text-sm bg-slate-50 font-medium">
                                {row.subtotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                              </td>
                            </tr>
                          ))}
                          <tr className="bg-slate-100 font-semibold">
                            <td className="border border-slate-300 px-4 py-2 text-sm" colSpan={3}>NLE All RIs Completed: BI Total</td>
                            <td className="border border-slate-300 px-4 py-2 text-sm">
                              {calculateNleAllRIsTotals().biTotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                            </td>
                          </tr>
                          <tr className="bg-slate-200 font-bold">
                            <td className="border border-slate-300 px-4 py-2 text-sm" colSpan={3}>NLE All RIs Completed: PD + BI Total</td>
                            <td className="border border-slate-300 px-4 py-2 text-sm">
                              {calculateNleAllRIsTotals().combinedTotal.toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}
                            </td>
                          </tr>
                        </tbody>
                      </table>
                      <button
                        type="button"
                        onClick={addNleAllRIsBIRow}
                        className="mt-3 flex items-center px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors"
                      >
                        <Plus className="w-4 h-4 mr-2" />
                        Add Recovery Phase
                      </button>
                    </div>
                  </div>
                </div>
              </div>

              <div>
                <label htmlFor="nleScenarioDescription" className="block text-sm font-medium text-slate-700 mb-2">
                  NLE Scenario Description
                </label>
                <textarea
                  id="nleScenarioDescription"
                  name="nleScenarioDescription"
                  value={formData.nleScenarioDescription}
                  onChange={handleInputChange}
                  rows={4}
                  className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all resize-y"
                  placeholder="Enter NLE scenario description"
                />
              </div>
            </div>
          </div>
            </>
          )}

          <div className="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
            <h2 className="text-2xl font-semibold text-slate-900 mb-6 pb-3 border-b border-slate-200">
              Section {getSectionNumber(10)}: Natural Hazards
            </h2>
            <div className="space-y-6">
              {naturalHazards.length === 0 ? (
                <p className="text-slate-600">No natural hazards recorded. Click the button below to add one.</p>
              ) : (
                naturalHazards.map((hazard, index) => (
                  <div key={hazard.id} className="p-4 border border-slate-200 rounded-lg bg-slate-50">
                    <div className="flex justify-between items-center mb-4">
                      <h3 className="text-lg font-medium text-slate-900">Natural Hazard {index + 1}</h3>
                      <button
                        type="button"
                        onClick={() => removeNaturalHazard(hazard.id)}
                        className="text-red-600 hover:text-red-700 transition-colors"
                      >
                        <Trash2 size={18} />
                      </button>
                    </div>

                    <div className="space-y-4">
                      <div>
                        <label htmlFor={`hazard-type-${hazard.id}`} className="block text-sm font-medium text-slate-700 mb-2">
                          Hazard Type
                        </label>
                        <select
                          id={`hazard-type-${hazard.id}`}
                          value={hazard.hazardType}
                          onChange={(e) => updateNaturalHazard(hazard.id, 'hazardType', e.target.value)}
                          className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent"
                        >
                          <option value="river_flooding">River Flooding</option>
                          <option value="surface_water_flooding">Surface Water Flooding</option>
                          <option value="earthquake">Earthquake</option>
                          <option value="windstorm">Windstorm</option>
                          <option value="other">Other</option>
                        </select>
                      </div>

                      <div>
                        <label htmlFor={`hazard-description-${hazard.id}`} className="block text-sm font-medium text-slate-700 mb-2">
                          Description
                        </label>
                        <textarea
                          id={`hazard-description-${hazard.id}`}
                          value={hazard.description}
                          onChange={(e) => updateNaturalHazard(hazard.id, 'description', e.target.value)}
                          rows={4}
                          className="w-full px-3 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent"
                          placeholder="Enter description of the natural hazard..."
                        />
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-slate-700 mb-2">
                          Hazard Rating
                        </label>
                        <div className="flex gap-3">
                          {[
                            { value: 'Good', label: 'Good ', color: 'green' },
                            { value: 'Tolerable', label: 'Tolerable ', color: 'amber' },
                            { value: 'Poor', label: 'Poor ', color: 'red' }
                          ].map((option) => (
                            <label
                              key={option.value}
                              className={`flex items-center gap-2 cursor-pointer px-4 py-2 rounded-lg border-2 transition-all flex-1 ${
                                hazard.rating === option.value
                                  ? option.color === 'green'
                                    ? 'bg-green-50 border-green-500 text-green-700'
                                    : option.color === 'amber'
                                    ? 'bg-amber-50 border-amber-500 text-amber-700'
                                    : 'bg-red-50 border-red-500 text-red-700'
                                  : 'border-slate-300 hover:border-slate-400 text-slate-700'
                              }`}
                            >
                              <input
                                type="radio"
                                name={`natural-hazard-rating-${hazard.id}`}
                                value={option.value}
                                checked={hazard.rating === option.value}
                                onChange={(e) => updateNaturalHazard(hazard.id, 'rating', e.target.value)}
                                className="sr-only"
                              />
                              <span className="text-sm font-medium">{option.label}</span>
                            </label>
                          ))}
                        </div>
                        <p className="text-xs text-slate-500 mt-2">
                          Good = Low concern; Tolerable = Minor concern; Poor = High risk
                        </p>
                      </div>
                    </div>
                  </div>
                ))
              )}

              <button
                type="button"
                onClick={addNaturalHazard}
                className="flex items-center px-4 py-2 text-sm font-medium text-slate-700 bg-white border border-slate-300 rounded-lg hover:bg-slate-50 transition-colors"
              >
                <Plus className="w-4 h-4 mr-2" />
                Add Natural Hazard Section
              </button>

              <SectionGrade
                sectionKey="natural_hazards"
                sectionTitle="Natural Hazards"
                value={formData.sectionGrades.natural_hazards || 3}
                onChange={(value) => handleSectionGradeChange('natural_hazards', value)}
                disabled={isIssued}
              />
            </div>
          </div>

          <div className="bg-gradient-to-r from-slate-50 to-slate-100 rounded-lg shadow-md border-2 border-slate-300 p-8">
            <div className="flex items-center justify-between">
              <div>
                <h3 className="text-sm font-medium text-slate-600 mb-1">Overall Property Grade</h3>
                <div className="flex items-baseline gap-3">
                  <span className="text-5xl font-bold text-slate-900">
                    {formData.overallGrade.toFixed(1)}
                  </span>
                  <span className="text-lg text-slate-600">/ 5.0</span>
                </div>
                <p className="text-xs text-slate-500 mt-1">Average of all section grades</p>
              </div>
              <div className="text-right">
                <h3 className="text-sm font-medium text-slate-600 mb-2">Risk Band</h3>
                <span className={`inline-block px-6 py-3 rounded-lg text-lg font-bold ${
                  formData.riskBand === 'Critical' ? 'bg-red-100 text-red-800 border-2 border-red-300' :
                  formData.riskBand === 'High' ? 'bg-orange-100 text-orange-800 border-2 border-orange-300' :
                  formData.riskBand === 'Medium' ? 'bg-amber-100 text-amber-800 border-2 border-amber-300' :
                  'bg-green-100 text-green-800 border-2 border-green-300'
                }`}>
                  {formData.riskBand}
                </span>
              </div>
            </div>
          </div>

          <div className="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
            <h2 className="text-2xl font-semibold text-slate-900 mb-6 pb-3 border-b border-slate-200">
              Section {getSectionNumber(11)}: Recommendations
            </h2>
            <div className="space-y-6">
              {overallComments.map((comment, index) => {
                const year = new Date().getFullYear();
                const recommendationNumber = String(index + 1).padStart(2, '0');
                const recommendationId = `${year}-${recommendationNumber}`;

                return (
                  <div key={comment.id} className={`p-4 border rounded-lg ${comment.isAutoGenerated ? 'border-blue-300 bg-blue-50' : 'border-slate-200 bg-slate-50'}`}>
                    <div className="flex justify-between items-start mb-4">
                      <div className="flex flex-col gap-2">
                        <h3 className="text-lg font-medium text-slate-900">{recommendationId}</h3>
                        {comment.isAutoGenerated && (
                          <span className="inline-flex items-center gap-1.5 px-3 py-1 text-xs font-medium text-blue-800 bg-blue-100 rounded-full border border-blue-200 w-fit">
                            <AlertCircle size={14} />
                            Auto-generated (editable)
                          </span>
                        )}
                      </div>
                      <button
                        type="button"
                        onClick={() => removeOverallComment(comment.id)}
                        className="text-red-600 hover:text-red-700 transition-colors"
                        title="Delete recommendation"
                      >
                        <Trash2 size={18} />
                      </button>
                    </div>

                    <div className="space-y-4">
                      <div>
                        <label htmlFor={`description-${comment.id}`} className="block text-sm font-medium text-slate-700 mb-2">
                          Description / Action {comment.isAutoGenerated && <span className="text-slate-500 text-xs">(You can edit this text)</span>}
                        </label>
                        <textarea
                          id={`description-${comment.id}`}
                          value={comment.description}
                          onChange={(e) => updateOverallComment(comment.id, 'description', e.target.value)}
                          rows={4}
                          className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all resize-y"
                          placeholder="Enter description or action required"
                        />
                      </div>

                      <div>
                        <label htmlFor={`hazard-${comment.id}`} className="block text-sm font-medium text-slate-700 mb-2">
                          Hazard
                        </label>
                        <textarea
                          id={`hazard-${comment.id}`}
                          value={comment.hazard}
                          onChange={(e) => updateOverallComment(comment.id, 'hazard', e.target.value)}
                          rows={3}
                          className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all resize-y"
                          placeholder="Describe the hazard"
                        />
                      </div>

                      <div>
                        <label htmlFor={`client_response-${comment.id}`} className="block text-sm font-medium text-slate-700 mb-2">
                          Client Response
                        </label>
                        <textarea
                          id={`client_response-${comment.id}`}
                          value={comment.client_response}
                          onChange={(e) => updateOverallComment(comment.id, 'client_response', e.target.value)}
                          rows={3}
                          className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all resize-y"
                          placeholder="Enter client comments or feedback"
                        />
                      </div>

                      <div>
                        <label htmlFor={`status-${comment.id}`} className="block text-sm font-medium text-slate-700 mb-2">
                          Status
                        </label>
                        <select
                          id={`status-${comment.id}`}
                          value={comment.status}
                          onChange={(e) => updateOverallComment(comment.id, 'status', e.target.value)}
                          className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all bg-white"
                        >
                          <option value="">Select status</option>
                          <option value="Completed">Completed</option>
                          <option value="Under Review">Under Review</option>
                          <option value="In Progress">In Progress</option>
                          <option value="Not Started">Not Started</option>
                          <option value="Rejected">Rejected</option>
                        </select>
                      </div>

                      <div className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                          <label htmlFor={`driver_dimension-${comment.id}`} className="block text-sm font-medium text-slate-700 mb-2">
                            Driver Dimension
                          </label>
                          <select
                            id={`driver_dimension-${comment.id}`}
                            value={comment.driver_dimension || ''}
                            onChange={(e) => updateOverallComment(comment.id, 'driver_dimension', e.target.value)}
                            className="w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all bg-white"
                          >
                            <option value="">Select dimension</option>
                            <option value="construction">Construction & Combustibility</option>
                            <option value="fire_protection">Fire Protection</option>
                            <option value="detection">Detection Systems</option>
                            <option value="management">Management Systems</option>
                            <option value="special_hazards">Special Hazards</option>
                            <option value="business_interruption">Business Interruption</option>
                          </select>
                          <p className="text-xs text-slate-500 mt-1">Select the risk dimension this recommendation addresses</p>
                        </div>

                        <div>
                          <label htmlFor={`priority-${comment.id}`} className="block text-sm font-medium text-slate-700 mb-2">
                            Priority
                          </label>
                          {(() => {
                            const dimensionToGradeKey: Record<string, keyof SectionGrades> = {
                              construction: 'construction',
                              fire_protection: 'fire_protection',
                              detection: 'fire_protection',
                              management: 'management',
                              special_hazards: 'hazards',
                              business_interruption: 'business_continuity',
                              natural_hazards: 'natural_hazards',
                            };

                            let autoPriority: string | undefined;
                            if (comment.driver_dimension) {
                              const gradeKey = dimensionToGradeKey[comment.driver_dimension];
                              if (gradeKey) {
                                const grade = formData.sectionGrades[gradeKey];
                                if (grade !== undefined && grade > 0) {
                                  if (grade === 1) autoPriority = 'Critical';
                                  else if (grade === 2) autoPriority = 'High';
                                  else if (grade === 3) autoPriority = 'Medium';
                                  else autoPriority = 'Low';
                                }
                              }
                            }

                            return (
                              <>
                                <select
                                  id={`priority-${comment.id}`}
                                  value={comment.priority_override || ''}
                                  onChange={(e) => updateOverallComment(comment.id, 'priority_override', e.target.value)}
                                  disabled={isIssued}
                                  className={`w-full px-4 py-2.5 border border-slate-300 rounded-lg focus:ring-2 focus:ring-slate-500 focus:border-transparent transition-all ${isIssued ? 'bg-slate-100 cursor-not-allowed' : 'bg-white'}`}
                                >
                                  <option value="">Auto ({autoPriority || 'None'})</option>
                                  <option value="Critical">Override: Critical</option>
                                  <option value="High">Override: High</option>
                                  <option value="Medium">Override: Medium</option>
                                  <option value="Low">Override: Low</option>
                                </select>
                                {isIssued && (
                                  <p className="text-xs text-amber-600 mt-1 font-medium">Issued report  editing locked</p>
                                )}
                              </>
                            );
                          })()}
                          {!isIssued && (
                            <p className="text-xs text-slate-500 mt-1">Auto-calculated from risk score, or manually override</p>
                          )}
                        </div>
                      </div>

                      <div>
                        <label className="block text-sm font-medium text-slate-700 mb-2">
                          Images (up to 3)
                        </label>
                        <div className="space-y-3">
                          {comment.images && comment.images.length > 0 && (
                            <div className="grid grid-cols-3 gap-3">
                              {comment.images.map((imageUrl, imgIndex) => (
                                <div key={imgIndex} className="relative group">
                                  <img
                                    src={imageUrl}
                                    alt={`Recommendation ${imgIndex + 1}`}
                                    className="w-full h-24 object-cover rounded-lg border border-slate-300"
                                  />
                                  <button
                                    type="button"
                                    onClick={() => removeRecommendationImage(comment.id, imageUrl)}
                                    className="absolute top-1 right-1 p-1 bg-red-600 text-white rounded-full hover:bg-red-700 transition-colors opacity-0 group-hover:opacity-100"
                                  >
                                    <X size={14} />
                                  </button>
                                </div>
                              ))}
                            </div>
                          )}
                          {(!comment.images || comment.images.length < 3) && (
                            <label
                              htmlFor={`recommendation-images-${comment.id}`}
                              className={`flex flex-col items-center justify-center w-full h-24 border-2 border-slate-300 border-dashed rounded-lg cursor-pointer bg-slate-50 hover:bg-slate-100 transition-colors ${isUploading ? 'opacity-50 cursor-not-allowed' : ''}`}
                            >
                              <div className="flex flex-col items-center justify-center">
                                <Upload className="w-6 h-6 mb-1 text-slate-500" />
                                <p className="text-xs text-slate-500">
                                  <span className="font-semibold">Click to upload</span>
                                </p>
                                <p className="text-xs text-slate-500">
                                  {comment.images ? 3 - comment.images.length : 3} remaining
                                </p>
                              </div>
                              <input
                                id={`recommendation-images-${comment.id}`}
                                type="file"
                                multiple
                                accept="image/*"
                                onChange={(e) => handleRecommendationImageUpload(comment.id, e)}
                                disabled={isUploading}
                                className="hidden"
                              />
                            </label>
                          )}
                        </div>
                      </div>
                    </div>
                  </div>
                );
              })}

              <button
                type="button"
                onClick={addOverallComment}
                className="flex items-center gap-2 px-4 py-2 bg-slate-900 text-white rounded-lg hover:bg-slate-800 transition-colors"
              >
                <Plus size={20} />
                Add Another Recommendation
              </button>

              <div className="flex items-start pt-4">
                <div className="flex items-center h-6">
                  <input
                    type="checkbox"
                    id="allowGenerateDraftRecommendations"
                    name="allowGenerateDraftRecommendations"
                    checked={formData.allowGenerateDraftRecommendations}
                    onChange={handleInputChange}
                    className="w-4 h-4 text-slate-900 border-slate-300 rounded focus:ring-2 focus:ring-slate-500"
                  />
                </div>
                <label htmlFor="allowGenerateDraftRecommendations" className="ml-3 text-sm font-medium text-slate-700">
                  Allow ClearRisk to generate draft recommendations
                </label>
              </div>
            </div>
          </div>

          <div className="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
            <h2 className="text-2xl font-semibold text-slate-900 mb-6 pb-3 border-b border-slate-200">
              Section {getSectionNumber(13)}: Photos & Site Plan
            </h2>
            <div className="space-y-6">
              <div>
                <h3 className="text-lg font-medium text-slate-900 mb-4">Photos</h3>
                <div className="space-y-4">
                  <div className="flex items-center justify-center w-full">
                    <label
                      htmlFor="photos-upload"
                      className={`flex flex-col items-center justify-center w-full h-32 border-2 border-slate-300 border-dashed rounded-lg cursor-pointer bg-slate-50 hover:bg-slate-100 transition-colors ${isUploading ? 'opacity-50 cursor-not-allowed' : ''}`}
                    >
                      <div className="flex flex-col items-center justify-center pt-5 pb-6">
                        <Upload className="w-8 h-8 mb-2 text-slate-500" />
                        <p className="mb-2 text-sm text-slate-500">
                          <span className="font-semibold">Click to upload photos</span> or drag and drop
                        </p>
                        <p className="text-xs text-slate-500">PNG, JPG, JPEG, GIF, WEBP (MAX. 50MB)</p>
                      </div>
                      <input
                        id="photos-upload"
                        type="file"
                        className="hidden"
                        multiple
                        accept="image/*"
                        onChange={(e) => handleFileUpload(e, 'photo')}
                        disabled={isUploading}
                      />
                    </label>
                  </div>

                  {uploadedFiles.filter(f => f.type === 'photo').length > 0 && (
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                      {uploadedFiles.filter(f => f.type === 'photo').map((file) => (
                        <div key={file.id} className="relative group border border-slate-200 rounded-lg p-2 bg-white">
                          <div className="aspect-video w-full bg-slate-100 rounded overflow-hidden mb-2">
                            <img
                              src={file.url}
                              alt={file.name}
                              className="w-full h-full object-cover"
                            />
                          </div>
                          <p className="text-sm text-slate-700 truncate mb-1">{file.name}</p>
                          <button
                            type="button"
                            onClick={() => removeFile(file.id, file.url)}
                            className="absolute top-3 right-3 p-1.5 bg-red-500 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity hover:bg-red-600"
                          >
                            <X size={16} />
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>

              <div>
                <h3 className="text-lg font-medium text-slate-900 mb-4">Site Plan</h3>
                <div className="space-y-4">
                  <div className="flex items-center justify-center w-full">
                    <label
                      htmlFor="site-plan-upload"
                      className={`flex flex-col items-center justify-center w-full h-32 border-2 border-slate-300 border-dashed rounded-lg cursor-pointer bg-slate-50 hover:bg-slate-100 transition-colors ${isUploading ? 'opacity-50 cursor-not-allowed' : ''}`}
                    >
                      <div className="flex flex-col items-center justify-center pt-5 pb-6">
                        <Upload className="w-8 h-8 mb-2 text-slate-500" />
                        <p className="mb-2 text-sm text-slate-500">
                          <span className="font-semibold">Click to upload site plan</span> or drag and drop
                        </p>
                        <p className="text-xs text-slate-500">PNG, JPG, JPEG, PDF (MAX. 50MB)</p>
                      </div>
                      <input
                        id="site-plan-upload"
                        type="file"
                        className="hidden"
                        multiple
                        accept="image/*,application/pdf"
                        onChange={(e) => handleFileUpload(e, 'site-plan')}
                        disabled={isUploading}
                      />
                    </label>
                  </div>

                  {uploadedFiles.filter(f => f.type === 'site-plan').length > 0 && (
                    <div className="space-y-2">
                      {uploadedFiles.filter(f => f.type === 'site-plan').map((file) => (
                        <div key={file.id} className="flex items-center justify-between p-3 border border-slate-200 rounded-lg bg-white group">
                          <div className="flex items-center gap-3 flex-1 min-w-0">
                            <FileText className="w-5 h-5 text-slate-500 flex-shrink-0" />
                            <span className="text-sm text-slate-700 truncate">{file.name}</span>
                          </div>
                          <button
                            type="button"
                            onClick={() => removeFile(file.id, file.url)}
                            className="p-1.5 text-red-600 hover:bg-red-50 rounded transition-colors flex-shrink-0"
                          >
                            <Trash2 size={16} />
                          </button>
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              </div>
            </div>
          </div>

          <div className="bg-white rounded-lg shadow-sm border border-slate-200 p-6">
            <h2 className="text-2xl font-semibold text-slate-900 mb-6 pb-3 border-b border-slate-200">
              Section {getSectionNumber(13)}: Report Status & Declaration
            </h2>
            <div className="space-y-6">
              <div>
                <label className="block text-sm font-medium text-slate-700 mb-3">
                  Report Status
                </label>
                <div className="space-y-2">
                  {(['Draft', 'Issue Ready'] as const).map((status) => (
                    <label
                      key={status}
                      className={`flex items-center gap-3 p-4 border-2 rounded-lg cursor-pointer transition-all ${
                        formData.reportStatus === status
                          ? status === 'Draft'
                            ? 'border-slate-400 bg-slate-50'
                            : 'border-green-500 bg-green-50'
                          : 'border-slate-200 hover:border-slate-300 bg-white'
                      }`}
                    >
                      <input
                        type="radio"
                        name="reportStatus"
                        value={status}
                        checked={formData.reportStatus === status}
                        onChange={(e) => setFormData(prev => ({ ...prev, reportStatus: e.target.value as typeof status }))}
                        className="w-4 h-4 text-slate-900 border-slate-300 focus:ring-2 focus:ring-slate-500"
                      />
                      <div className="flex-1">
                        <div className="flex items-center gap-2">
                          <span className={`font-medium ${
                            formData.reportStatus === status
                              ? status === 'Draft'
                                ? 'text-slate-900'
                                : 'text-green-900'
                              : 'text-slate-700'
                          }`}>
                            {status}
                          </span>
                          {formData.reportStatus === status && (
                            <span className={`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${
                              status === 'Draft'
                                ? 'bg-slate-200 text-slate-700'
                                : 'bg-green-200 text-green-700'
                            }`}>
                              Selected
                            </span>
                          )}
                        </div>
                        <p className="text-sm text-slate-600 mt-1">
                          {status === 'Draft' && 'Auto-generated / working document'}
                          {status === 'Issue Ready' && 'Checked and suitable for issue'}
                        </p>
                      </div>
                    </label>
                  ))}
                </div>
              </div>

              <div className={`p-4 rounded-lg border-2 ${
                formData.reportStatus === 'Draft'
                  ? 'bg-slate-50 border-slate-300'
                  : 'bg-green-50 border-green-300'
              }`}>
                <h3 className="text-sm font-semibold text-slate-900 mb-2">Disclaimer</h3>
                <div className="text-sm text-slate-700 leading-relaxed">
                  {formData.reportStatus === 'Draft' && (
                    <p>
                      This draft report has been prepared using ClearRisk as a report drafting and summarisation tool.
                      The content is provided for review and refinement and should not be relied upon without professional verification.
                      Final responsibility for interpretation and implementation of recommendations remains with the competent professional and duty holder.
                    </p>
                  )}
                  {formData.reportStatus === 'Issue Ready' && (
                    <p>
                      This report represents a professional opinion based on observations and information available at the time of survey.
                      It does not constitute a guarantee of loss prevention performance.
                      Responsibility for implementation of recommendations remains with the duty holder.
                    </p>
                  )}
                </div>
              </div>

              {submitStatus === 'success' && (
                <div className="flex items-start gap-3 p-4 bg-green-50 border border-green-200 rounded-lg">
                  <CheckCircle2 className="w-5 h-5 text-green-600 flex-shrink-0 mt-0.5" />
                  <div>
                    <p className="text-green-800 font-medium">Survey report submitted successfully!</p>
                    <p className="text-green-700 text-sm mt-1">Your report has been saved to the system.</p>
                  </div>
                </div>
              )}

              {submitStatus === 'error' && (
                <div className="flex items-start gap-3 p-4 bg-red-50 border border-red-200 rounded-lg">
                  <AlertCircle className="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" />
                  <div>
                    <p className="text-red-800 font-medium">Submission failed</p>
                    <p className="text-red-700 text-sm mt-1">{errorMessage}</p>
                  </div>
                </div>
              )}

              {saveStatus === 'success' && (
                <div className="flex items-start gap-3 p-4 bg-blue-50 border border-blue-200 rounded-lg">
                  <CheckCircle2 className="w-5 h-5 text-blue-600 flex-shrink-0 mt-0.5" />
                  <div>
                    <p className="text-blue-800 font-medium">
                      {currentSurveyId ? 'Survey updated successfully!' : 'Survey saved successfully!'}
                    </p>
                    <p className="text-blue-700 text-sm mt-1">Your survey has been saved. You can generate the report later.</p>
                  </div>
                </div>
              )}

              {saveStatus === 'error' && (
                <div className="flex items-start gap-3 p-4 bg-red-50 border border-red-200 rounded-lg">
                  <AlertCircle className="w-5 h-5 text-red-600 flex-shrink-0 mt-0.5" />
                  <div>
                    <p className="text-red-800 font-medium">Save failed</p>
                    <p className="text-red-700 text-sm mt-1">{saveErrorMessage}</p>
                  </div>
                </div>
              )}
            </div>
          </div>

        </form>
      </div>

      <StickySaveButton
        onSave={handleSaveSurvey}
        onViewDraft={handleViewDraft}
        lastSaved={lastSaved}
        isSaving={isSaving}
        onBackToDashboard={onCancel}
        isReadOnly={isIssued}
      />

      {generatedReport && (
        <DraftReportModal
          isOpen={isDraftModalOpen}
          onClose={() => setIsDraftModalOpen(false)}
          sections={generatedReport.sections}
          fullText={generatedReport.fullText}
          onDownload={handleDownloadReport}
          propertyName={formData.propertyName}
          referenceNumber={formData.referenceNumber}
          reportStatus={formData.reportStatus}
          inspectionDate={formData.inspectionDate}
          surveyorName={formData.surveyorName}
          recommendations={overallComments.map(c => ({ title: c.hazard, description: c.description }))}
        />
      )}
    </div>
  );
}
