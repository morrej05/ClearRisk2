# Risk Engineering Recommendations System - RESTORED

**Date:** 2026-01-31  
**Status:** âœ… AUTO-RECOMMENDATION SYSTEM COMPLETE  
**File:** `src/components/modules/forms/RiskEngineeringForm.tsx`  

---

## Summary

The auto-recommendation button system from the legacy Risk Engineering flow has been **fully restored**. Recommendations are now:
- **Auto-generated** based on poor section ratings (1-2)
- **Manually added** via "Add Manual" button
- **Stored in** `module_instances.data.recommendations[]`
- **Available for** report generation and PDF output

---

## Features Restored

### âœ… 1. Auto-Generation Logic

Recommendations are **automatically generated** when any section is rated 1 or 2:

```typescript
useEffect(() => {
  sections.forEach(section => {
    const rating = sectionGrades[section.key];
    
    // Generate recommendation if rating is 1 or 2 (Poor or Tolerable)
    if (rating <= 2) {
      if (!existingRecommendation) {
        const severity = rating === 1 ? 'Critical' : 'High';
        const newRec: Recommendation = {
          id: crypto.randomUUID(),
          hazard: `${section.name} - ${rating === 1 ? 'Poor' : 'Tolerable'} Rating`,
          description: `The ${section.name.toLowerCase()} section has been rated as ${rating === 1 ? 'poor' : 'tolerable'} and requires immediate attention...`,
          priority: severity,
          isAutoGenerated: true,
          sourceRatingField: `section_grade_${section.key}`,
          driver_dimension: section.key
        };
        setRecommendations(prev => [...prev, newRec]);
      }
    } else {
      // Remove auto-generated recommendation if rating improves
      if (existingRecommendation) {
        setRecommendations(prev => prev.filter(rec => rec.id !== existingRecommendation.id));
      }
    }
  });
}, [sectionGrades]);
```

**Trigger Conditions:**
- Construction rating = 1 or 2 â†’ Auto-generate "Construction - Poor/Tolerable Rating"
- Fire Protection rating = 1 or 2 â†’ Auto-generate "Fire Protection - Poor/Tolerable Rating"
- Management Systems rating = 1 or 2 â†’ Auto-generate "Management Systems - Poor/Tolerable Rating"
- Natural Hazards rating = 1 or 2 â†’ Auto-generate "Natural Hazards - Poor/Tolerable Rating"
- Business Continuity rating = 1 or 2 â†’ Auto-generate "Business Continuity - Poor/Tolerable Rating"
- Loss Expectancy rating = 1 or 2 â†’ Auto-generate "Loss Expectancy - Poor/Tolerable Rating"

**Auto-Removal:**
- When rating improves to 3+, auto-generated recommendation is automatically removed

### âœ… 2. Manual Recommendation Button

```typescript
const addManualRecommendation = () => {
  const newRec: Recommendation = {
    id: crypto.randomUUID(),
    hazard: '',
    description: '',
    client_response: '',
    status: 'open',
    isAutoGenerated: false,
    priority: 'Medium'
  };
  setRecommendations([...recommendations, newRec]);
};
```

**UI Button:**
```tsx
<button onClick={addManualRecommendation}>
  <Plus /> Add Manual
</button>
```

### âœ… 3. Recommendation Data Structure

```typescript
interface Recommendation {
  id: string;                    // Unique identifier
  hazard: string;                // Title of hazard/finding
  description: string;           // Detailed description and action
  client_response: string;       // Client's response/action taken
  status: string;                // open | in_progress | completed | closed
  isAutoGenerated?: boolean;     // True if auto-generated
  sourceRatingField?: string;    // Source section (e.g., "section_grade_construction")
  priority?: 'Critical' | 'High' | 'Medium' | 'Low';
  driver_dimension?: 'construction' | 'fire_protection' | 'management_systems' | 
                     'natural_hazards' | 'business_continuity' | 'loss_expectancy';
}
```

### âœ… 4. Recommendations UI Section

**Location:** After Business Continuity section, before ModuleActions  
**Features:**
- Collapsible section header
- Empty state message when no recommendations
- Auto-generated recommendations highlighted in blue
- Manual recommendations in white cards
- Each recommendation shows:
  - Number badge (#1, #2, etc.)
  - Priority badge (Critical/High/Medium/Low)
  - Auto-Generated badge (if applicable)
  - Editable fields:
    - Hazard/Finding (disabled for auto-generated)
    - Description/Recommended Action
    - Client Response (optional)
    - Status dropdown (Open/In Progress/Completed/Closed)
    - Priority dropdown (manual recommendations only)
  - Remove button (disabled for auto-generated)

**Visual Distinction:**
- Auto-generated: Blue background (`bg-blue-50 border-blue-200`)
- Manual: White background (`bg-white border-neutral-300`)

### âœ… 5. Data Persistence

**Save:**
```typescript
const data = {
  // ... all other fields ...
  sectionGrades,
  recommendations,  // â† Added to save payload
};

await supabase
  .from('module_instances')
  .update({ data: sanitized })
  .eq('id', moduleInstance.id);
```

**Load:**
```typescript
const initial = {
  // ... all other fields ...
  recommendations: d.recommendations ?? [],  // â† Load from module_instances.data
};
```

### âœ… 6. Report Integration

Recommendations are stored in `module_instances.data.recommendations[]` and ready for report generation:

```typescript
// Available in report generator
const recommendations = moduleInstance.data.recommendations;
// [
//   {
//     id: "uuid",
//     hazard: "Construction - Poor Rating",
//     description: "The construction section has been rated as poor...",
//     priority: "Critical",
//     isAutoGenerated: true,
//     driver_dimension: "construction"
//   },
//   ...
// ]
```

---

## UI Screenshots (Description)

### Empty State
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â–¼ Recommendations                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Recommendations are auto-generated based on     â”‚
â”‚ section ratings (1-2), or you can add manual    â”‚
â”‚                                    [+ Add Manual]â”‚
â”‚                                                 â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚ â”‚  No recommendations yet. Rate sections    â”‚  â”‚
â”‚ â”‚  1-2 to auto-generate, or add manually.   â”‚  â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### With Auto-Generated Recommendation
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â–¼ Recommendations                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ #1 [Critical] [Auto-Generated]          [ğŸ—‘]â”‚ â”‚
â”‚ â”‚                                             â”‚ â”‚
â”‚ â”‚ Hazard: Construction - Poor Rating          â”‚ â”‚
â”‚ â”‚ Description: The construction section has   â”‚ â”‚
â”‚ â”‚ been rated as poor and requires immediate   â”‚ â”‚
â”‚ â”‚ attention to address identified deficienc...â”‚ â”‚
â”‚ â”‚                                             â”‚ â”‚
â”‚ â”‚ Client Response: [editable]                 â”‚ â”‚
â”‚ â”‚ Status: [Open â–¼]                            â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                                                 â”‚
â”‚ Auto-Generation Rules:                          â”‚
â”‚ â€¢ Recommendations auto-generated when section   â”‚
â”‚   is rated 1 (Poor) or 2 (Tolerable)            â”‚
â”‚ â€¢ Auto-generated recs removed when rating       â”‚
â”‚   improves to 3 or above                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### With Manual Recommendation
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ â–¼ Recommendations                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚ â”‚ #2 [High]                               [ğŸ—‘]â”‚ â”‚
â”‚ â”‚                                             â”‚ â”‚
â”‚ â”‚ Hazard: [editable]                          â”‚ â”‚
â”‚ â”‚ Description: [editable]                     â”‚ â”‚
â”‚ â”‚ Client Response: [editable]                 â”‚ â”‚
â”‚ â”‚ Status: [Open â–¼]  Priority: [High â–¼]       â”‚ â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Testing Checklist

### Auto-Generation
- âœ… Set Construction grade to 1 â†’ See "Construction - Poor Rating" recommendation appear
- âœ… Set Fire Protection grade to 2 â†’ See "Fire Protection - Tolerable Rating" recommendation appear
- âœ… Improve Construction grade to 3 â†’ See auto-generated Construction recommendation disappear
- âœ… Auto-generated recommendations are marked with blue background
- âœ… Auto-generated recommendations cannot be manually removed
- âœ… Auto-generated recommendations have hazard field disabled

### Manual Add/Remove
- âœ… Click "Add Manual" â†’ New blank recommendation appears
- âœ… Fill in hazard, description â†’ Save â†’ Reload â†’ Values persist
- âœ… Change priority dropdown â†’ Save â†’ Reload â†’ Priority persists
- âœ… Change status dropdown â†’ Save â†’ Reload â†’ Status persists
- âœ… Click remove button â†’ Recommendation deleted
- âœ… Manual recommendations can be edited and removed

### Data Persistence
- âœ… Generate 2 auto-recommendations + add 1 manual â†’ Save â†’ Reload â†’ All 3 persist
- âœ… Close and reopen document â†’ Recommendations still there
- âœ… Recommendations array saves to `module_instances.data.recommendations`

### Priority Badges
- âœ… Critical = Red badge
- âœ… High = Orange badge
- âœ… Medium = Yellow badge
- âœ… Low = Green badge

---

## Build Status

```bash
npm run build
âœ“ 1908 modules transformed
âœ“ built in 14.67s
```

**Result:** âœ… Build successful, no TypeScript errors

---

## Differences from Legacy System

### Legacy (NewSurveyReport.tsx)
- Stored in `survey_reports.form_data.overall_comments`
- Could add from library (RecommendationLibraryModal with survey_recommendations table)
- Manual and auto-generated mixed together

### Modular (RiskEngineeringForm.tsx)
- Stored in `module_instances.data.recommendations`
- Currently only manual add (library integration can be added later)
- Auto-generated based on section grades (1-2)
- Clear visual distinction (blue vs white)
- Auto-removal when rating improves

### What's Not Included (Yet)
- âŒ RecommendationLibraryModal integration (requires document-level recommendation_templates system)
- âŒ "Add from Library" button (can be added when library system is adapted)

The current implementation provides:
âœ… Auto-generation based on ratings  
âœ… Manual add/edit/remove  
âœ… Complete data persistence  
âœ… Visual feedback  
âœ… Ready for report generation  

---

## Summary

The auto-recommendation system has been successfully restored to RiskEngineeringForm.tsx:
- âœ… **Auto-generation** triggers on section ratings 1-2
- âœ… **Manual add** button for custom recommendations
- âœ… **Complete UI** with priority badges and status tracking
- âœ… **Data persistence** in module_instances.data.recommendations
- âœ… **Report-ready** structure for PDF generation
- âœ… **Visual distinction** between auto and manual recommendations

**All recommendation data is now captured and ready for report output.**
