# Risk Engineering - Force Real Sections Diagnostic

**Date:** 2026-01-31  
**Status:** ✅ DIAGNOSTIC BLOCKS ACTIVE  
**File:** `src/components/modules/forms/RiskEngineeringForm.tsx`  

---

## Objective

Force render the **actual** Construction, Fire Protection, and Recommendations UI blocks directly after the debug banner with **no conditionals, no accordion, no tabs** to diagnose whether:
1. The sections themselves render correctly
2. The issue is with the accordion/collapse logic

---

## Implementation

### Location
Lines 539-796 (immediately after debug banner at line 537)

### Three Diagnostic Blocks

#### 1. FORCE REAL: Construction (Green Border)
```tsx
<div className="mb-6 p-6 border-8 border-green-500 bg-green-50 rounded-lg">
  <h3 className="text-2xl font-bold text-green-900 mb-4">FORCE REAL: Construction</h3>
  {/* Exact same JSX as the normal Construction section */}
  <table>
    <tbody>
      {constructionElements.map((elem, idx) => (
        <tr>
          <td>{elem.element}</td>
          <td><input value={elem.type_material} onChange={...} /></td>
          <td><input value={elem.fire_resistance} onChange={...} /></td>
        </tr>
      ))}
    </tbody>
  </table>
  <SectionGrade 
    sectionKey="construction"
    value={sectionGrades.construction}
    onChange={(value) => handleSectionGradeChange('construction', value)}
  />
</div>
```

**Data Bound To:**
- `constructionElements` (6 rows: Frame, External Walls, Roof, Internal Walls, Floors, Ceilings)
- `sectionGrades.construction` (1-5 rating)

**Renders:**
- ✅ Table with 3 columns (Element, Type/Material, Fire Resistance)
- ✅ 6 editable input rows
- ✅ SectionGrade component with 1-5 radio buttons

---

#### 2. FORCE REAL: Fire Protection (Orange Border)
```tsx
<div className="mb-6 p-6 border-8 border-orange-500 bg-orange-50 rounded-lg">
  <h3 className="text-2xl font-bold text-orange-900 mb-4">FORCE REAL: Fire Protection</h3>
  {/* Exact same JSX as the normal Fire Protection section */}
  <table>
    <tbody>
      {fireProtectionItems.map((item, idx) => (
        <tr>
          <td>{item.system}</td>
          <td><input value={item.coverage_notes} onChange={...} /></td>
        </tr>
      ))}
    </tbody>
  </table>
  <SectionGrade 
    sectionKey="fire_protection"
    value={sectionGrades.fire_protection}
    onChange={(value) => handleSectionGradeChange('fire_protection', value)}
  />
</div>
```

**Data Bound To:**
- `fireProtectionItems` (11 rows: Sprinklers, Detection, Alarms, Extinguishers, etc.)
- `sectionGrades.fire_protection` (1-5 rating)

**Renders:**
- ✅ Table with 2 columns (System, Coverage/Notes)
- ✅ 11 editable input rows
- ✅ SectionGrade component with 1-5 radio buttons

---

#### 3. FORCE REAL: Recommendations (Purple Border)
```tsx
<div className="mb-6 p-6 border-8 border-purple-500 bg-purple-50 rounded-lg">
  <h3 className="text-2xl font-bold text-purple-900 mb-4">FORCE REAL: Recommendations</h3>
  {/* Exact same JSX as the normal Recommendations section */}
  
  <button onClick={addManualRecommendation}>
    <Plus /> Add Manual
  </button>
  
  {recommendations.length === 0 ? (
    <div>No recommendations yet. Rate sections 1-2 to auto-generate, or add manually.</div>
  ) : (
    <div>
      {recommendations.map((rec, idx) => (
        <div key={rec.id}>
          <span>#{idx + 1}</span>
          <span>{rec.priority}</span>
          {rec.isAutoGenerated && <span>Auto-Generated</span>}
          
          <input value={rec.hazard} onChange={...} disabled={rec.isAutoGenerated} />
          <textarea value={rec.description} onChange={...} />
          <textarea value={rec.client_response} onChange={...} />
          
          <select value={rec.status} onChange={...}>
            <option value="open">Open</option>
            <option value="in_progress">In Progress</option>
            <option value="completed">Completed</option>
            <option value="closed">Closed</option>
          </select>
          
          {!rec.isAutoGenerated && (
            <select value={rec.priority} onChange={...}>
              <option value="Critical">Critical</option>
              <option value="High">High</option>
              <option value="Medium">Medium</option>
              <option value="Low">Low</option>
            </select>
          )}
          
          <button onClick={() => removeRecommendation(rec.id)} disabled={rec.isAutoGenerated}>
            <Trash2 />
          </button>
        </div>
      ))}
    </div>
  )}
  
  <div>Auto-Generation Rules...</div>
</div>
```

**Data Bound To:**
- `recommendations` (array of Recommendation objects)
- Auto-generated when `sectionGrades.*` = 1 or 2

**Renders:**
- ✅ "Add Manual" button
- ✅ Empty state if no recommendations
- ✅ Cards for each recommendation with all fields
- ✅ Auto-generation info panel

---

## Visual Identification

When you open the RE form, you should immediately see THREE colored blocks:

```
┌─────────────────────────────────────────────────┐
│ [Blue] RE DEBUG - RESTORED IMPLEMENTATION       │
│ BOUND KEYS (36): constructionElements, fire...  │
└─────────────────────────────────────────────────┘

┌═════════════════════════════════════════════════┐
║ [GREEN BORDER - 8px]                            ║
║ FORCE REAL: Construction                        ║
║                                                 ║
║ ┌─────────────────────────────────────────────┐ ║
║ │ Element    │ Type/Material │ Fire Resistance│ ║
║ ├────────────┼───────────────┼────────────────┤ ║
║ │ Frame      │ [input]       │ [input]        │ ║
║ │ Ext Walls  │ [input]       │ [input]        │ ║
║ │ Roof       │ [input]       │ [input]        │ ║
║ │ Int Walls  │ [input]       │ [input]        │ ║
║ │ Floors     │ [input]       │ [input]        │ ║
║ │ Ceilings   │ [input]       │ [input]        │ ║
║ └─────────────────────────────────────────────┘ ║
║ [Section Grade: 1 2 3 4 5]                      ║
╚═════════════════════════════════════════════════╝

┌═════════════════════════════════════════════════┐
║ [ORANGE BORDER - 8px]                           ║
║ FORCE REAL: Fire Protection                     ║
║                                                 ║
║ ┌─────────────────────────────────────────────┐ ║
║ │ System           │ Coverage / Notes         │ ║
║ ├──────────────────┼──────────────────────────┤ ║
║ │ Sprinklers       │ [input]                  │ ║
║ │ Detection        │ [input]                  │ ║
║ │ ... (11 rows)    │ [input]                  │ ║
║ └─────────────────────────────────────────────┘ ║
║ [Section Grade: 1 2 3 4 5]                      ║
╚═════════════════════════════════════════════════╝

┌═════════════════════════════════════════════════┐
║ [PURPLE BORDER - 8px]                           ║
║ FORCE REAL: Recommendations                     ║
║                                    [+ Add Manual]║
║                                                 ║
║ No recommendations yet. Rate sections 1-2 to    ║
║ auto-generate, or add manually.                 ║
║                                                 ║
║ Auto-Generation Rules:                          ║
║ • Recommendations auto-generated when...        ║
╚═════════════════════════════════════════════════╝

[... then normal sections below with SectionHeader ...]
```

---

## What This Tests

### ✅ If These Blocks Appear and Work
**Conclusion:** The sections themselves are fine. The problem is:
- `isSectionExpanded()` returning false
- `SectionHeader` accordion logic hiding content
- CSS (overflow: hidden, h-0, collapsed state)

**Fix:** 
1. Remove conditionals from normal sections OR
2. Make sections expanded by default OR
3. Fix SectionHeader toggle logic

### ❌ If These Blocks Don't Appear or Crash
**Conclusion:** The data or components have issues:
- `constructionElements` / `fireProtectionItems` / `recommendations` are broken
- `SectionGrade` component has bugs
- State binding is broken

---

## Testing Steps

1. **Open any RE document**
   - Go to Documents → Select RE document → Open

2. **Scroll down from top**
   - See blue debug banner
   - Immediately below: GREEN "FORCE REAL: Construction"
   - Immediately below: ORANGE "FORCE REAL: Fire Protection"
   - Immediately below: PURPLE "FORCE REAL: Recommendations"

3. **Interact with forced blocks**
   - Edit Construction table inputs → Type text → Verify onChange fires
   - Edit Fire Protection table inputs → Type text → Verify onChange fires
   - Click Construction section grade (1-5) → Verify rating changes
   - Click Fire Protection section grade (1-5) → Verify rating changes
   - If rating ≤ 2, see auto-recommendation appear in purple block
   - Click "Add Manual" in Recommendations → See new card appear
   - Edit recommendation fields → Verify onChange fires
   - Click Save → Reload → Verify forced blocks still show edited data

4. **Compare with normal sections**
   - Scroll further down to find "Construction Elements" section (line 798+)
   - Does it have a SectionHeader?
   - Is `isSectionExpanded('construction')` returning false?
   - If so, that's the bug!

---

## Next Steps (If Forced Blocks Work)

### Option A: Remove Accordion Conditionals
```tsx
// OLD (line 801)
{isSectionExpanded('construction') && (
  <div>...</div>
)}

// NEW
<div>...</div>  // Always show, no conditional
```

### Option B: Force Expanded by Default
```tsx
const [expandedSections, setExpandedSections] = useState<Record<string, boolean>>({
  construction: true,       // ← Add these
  fireProtection: true,     // ← Add these
  recommendations: true,    // ← Add these
  // ... rest
});
```

### Option C: Fix SectionHeader Toggle
Find `SectionHeader` component and ensure:
- Click handler toggles `expandedSections[sectionKey]`
- Initial state isn't collapsed by CSS
- No `h-0`, `overflow-hidden`, `hidden` classes

---

## Build Status

```bash
npm run build
✓ 1908 modules transformed
✓ built in 15.57s
```

**Result:** ✅ Build successful

---

## Summary

Three diagnostic blocks force-render the **actual** Construction, Fire Protection, and Recommendations sections:
- ✅ Green border (Construction)
- ✅ Orange border (Fire Protection)
- ✅ Purple border (Recommendations)

These blocks use **identical JSX** to the normal sections but have **no conditionals**.

**If they display correctly → The accordion/collapse logic is the problem.**  
**If they don't display → The components/data are broken.**

This diagnostic will definitively identify where the issue lies.
